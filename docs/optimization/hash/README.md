# Hashç®—æ³•ä¼˜åŒ–æŒ‡å—ä¸ç»éªŒæ•™è®­

**ç‰ˆæœ¬**: v3.4.0+  
**æ—¥æœŸ**: 2026-01-16  
**ä½œè€…**: kctsbå¼€å‘å›¢é˜Ÿ

æœ¬æ–‡æ¡£æ€»ç»“kctsb hashç®—æ³•ä¼˜åŒ–è¿‡ç¨‹ä¸­çš„ç»éªŒã€æ•™è®­å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“Š å½“å‰æ€§èƒ½çŠ¶æ€ (10MBæ•°æ®é›†)

| ç®—æ³• | kctsb | OpenSSL | ç›¸å¯¹æ€§èƒ½ | çŠ¶æ€ |
|------|-------|---------|----------|------|
| BLAKE2b-512 | 914 MB/s | 767 MB/s | **+19.19%** | â« [AVX2ç ”ç©¶](blake2b-avx2-research.md) |
| SHA3-512 | 325 MB/s | 322 MB/s | **+0.71%** | âœ… è¶…è¶Š |
| SHA3-256 | 567 MB/s | 606 MB/s | **-6.44%** | âš ï¸ æ¥è¿‘ |
| SHA-256 | 1914 MB/s | 1982 MB/s | **-3.44%** | âš ï¸ æ¥è¿‘ |
| SHA-512 | 800 MB/s | 922 MB/s | **-13.21%** | âŒ å·®è· |
| SM3 | 377 MB/s | 260 MB/s | **+45.24%** | âœ… è¶…è¶Š |

---

## ğŸ¯ ä¼˜åŒ–ç­–ç•¥æ€»ç»“

### ğŸš€ å‰æ²¿ç ”ç©¶ (2026-01-16æ–°å¢)

#### ğŸ”¬ BLAKE2b AVX2å‘é‡åŒ– (ç›®æ ‡>1913 MB/s)
**å‚è€ƒ**: [BLAKE2b AVX2ä¼˜åŒ–æ·±åº¦ç ”ç©¶](blake2b-avx2-research.md) | [å‚è€ƒä»£ç ](blake2b_avx2_reference.c)

**æ ¸å¿ƒæŠ€æœ¯**:
- **4-wayå¹¶è¡Œå‹ç¼©**: ä½¿ç”¨AVX2 256ä½å¯„å­˜å™¨åŒæ—¶å¤„ç†4ä¸ª64ä½æ“ä½œ
- **Gå‡½æ•°å‘é‡åŒ–**: `_mm256_add_epi64` / `_mm256_xor_si256` / `_mm256_shuffle_epi32`
- **æ—‹è½¬ä¼˜åŒ–**: 32ä½æ—‹è½¬ç”¨shuffleæ›¿ä»£ç§»ä½ (~3xæ€§èƒ½æå‡)
- **æ¶ˆæ¯è°ƒåº¦SIMDé€‚é…**: 96ä¸ªé¢„å®šä¹‰å®é¿å…éšæœºå†…å­˜è®¿é—®

**æ€§èƒ½ç›®æ ‡**:
```
å½“å‰: 914 MB/s (portable)
ç›®æ ‡: >1913 MB/s (AVX2, ç†è®º2.5xåŠ é€Ÿ)
å‚è€ƒ: sneves/blake2-avx2è¾¾åˆ°900-920 MB/s
```

**ä¸‹ä¸€æ­¥**:
1. å®ç°`G1_AVX2`/`G2_AVX2`æ ¸å¿ƒå® (é¢„è®¡+100%æ€§èƒ½)
2. å®šä¹‰12è½®æ¶ˆæ¯è°ƒåº¦å® (é¢„è®¡+30%æ€§èƒ½)
3. DIAGONALIZEå‘é‡åŒ– (é¢„è®¡+20%æ€§èƒ½)

**å‚è€ƒèµ„æº**:
- Samuel Nevesè®ºæ–‡: [IACR 2012/275](https://eprint.iacr.org/2012/275)
- å®˜æ–¹å®ç°: [sneves/blake2-avx2](https://github.com/sneves/blake2-avx2)
- IntelæŒ‡ä»¤é›†: [Intrinsics Guide](https://www.intel.com/content/www/us/en/docs/intrinsics-guide/)

---

### 1. æˆåŠŸçš„ä¼˜åŒ–æ¡ˆä¾‹

#### âœ… SHA-256: 4-block Batching (+4.28pp)
**ç­–ç•¥**: æ¿€è¿›çš„é¢„å– + 4å—æ‰¹å¤„ç†

```cpp
// 256å­—èŠ‚é¢„å–é€‚é…L1ç¼“å­˜
while (len >= 4 * KCTSB_SHA256_BLOCK_SIZE) {
    KCTSB_PREFETCH(data + 4 * KCTSB_SHA256_BLOCK_SIZE);
    
    // 4ä¸ªtransformè°ƒç”¨å¹¶è¡ŒåŒ–CPUæµæ°´çº¿
    transform(ctx, data);
    transform(ctx, data + 64);
    transform(ctx, data + 128);
    transform(ctx, data + 192);
    
    data += 4 * KCTSB_SHA256_BLOCK_SIZE;
    len -= 4 * KCTSB_SHA256_BLOCK_SIZE;
}
```

**å…³é”®ç‚¹**:
- é¢„å–è·ç¦» = 4å— (256å­—èŠ‚ï¼Œé€‚é…L1ç¼“å­˜å¤§å°)
- è¿ç»­4ä¸ªtransformè°ƒç”¨è®©ç¼–è¯‘å™¨æ›´å¥½åœ°ä¼˜åŒ–æµæ°´çº¿
- æ€§èƒ½ä»-7.72%æ”¹å–„åˆ°-3.44%

**é€‚ç”¨åœºæ™¯**: SHA-NIç¡¬ä»¶åŠ é€Ÿå¯ç”¨æ—¶ï¼Œå¤§æ•°æ®æµå¤„ç†

#### âœ… SHA-512: 4-round Batching Macro
**ç­–ç•¥**: å®å±•å¼€å‡å°‘EXPAND/ROUNDäº¤é”™ä¾èµ–

```cpp
#define EXPAND_ROUND_4(i, k) do { \
    EXPAND(i);   ROUND(i, k);     \
    EXPAND(i+1); ROUND(i+1, k+1); \
    EXPAND(i+2); ROUND(i+2, k+2); \
    EXPAND(i+3); ROUND(i+3, k+3); \
} while(0)

// ä½¿ç”¨
EXPAND_ROUND_4(0, 16);  EXPAND_ROUND_4(4, 20);
```

**å…³é”®ç‚¹**:
- ä»£ç ä»64è¡Œäº¤é”™å±•å¼€â†’16è¡Œç´§å‡‘å®
- æå‡æŒ‡ä»¤çº§å¹¶è¡Œåº¦ (ILP)
- æ€§èƒ½ä»-13.32%æ”¹å–„åˆ°-13.21%ï¼ˆå¾®å¼±ä½†æ­£å‘ï¼‰

**å±€é™æ€§**: SHA-512å—é™äºç¼ºå°‘AVX512-IFMAç¡¬ä»¶æŒ‡ä»¤

#### âœ… BLAKE2b/SM3: Cache-Friendly Design
**BLAKE2b**:
- ä½¿ç”¨64å­—èŠ‚å¯¹é½çš„stateæ•°ç»„
- å¾ªç¯å±•å¼€ä¼˜åŒ–ï¼ˆ8-wayï¼‰
- è¶…è¶ŠOpenSSL 19.19%

**SM3**:
- å›½å¯†ç®—æ³•ï¼Œè½»é‡çº§è®¾è®¡
- çº¯Cä¼˜åŒ–è¶³ä»¥è¶…è¶ŠOpenSSL 45.24%
- æœªæ¥å¯åŠ SIMDè¿›ä¸€æ­¥æå‡

---

### 2. å¤±è´¥çš„ä¼˜åŒ–å°è¯•

#### âŒ AVX512åŒå—å¹¶è¡Œ (SHA-512)
**å°è¯•**: åŒæ—¶å¤„ç†2ä¸ª128å­—èŠ‚å—

```cpp
static void transform_avx512_dual(ctx, block1, block2) {
    uint64_t W1[16], W2[16];
    uint64_t a1, b1, c1, d1, e1, f1, g1, h1;
    uint64_t a2, b2, c2, d2, e2, f2, g2, h2;
    // ... åŒçŠ¶æ€å˜é‡å¤„ç†
}
```

**ç»“æœ**: **ç¾éš¾æ€§å¤±è´¥** -16.70% (ä»-12.04%æ¶åŒ–)

**å¤±è´¥åŸå› **:
1. **ä¼ªå¹¶è¡Œ**: æœ¬è´¨æ˜¯ä¸²è¡Œå¤„ç† + çŠ¶æ€ç®¡ç†å¼€é”€
2. **æ— çœŸSIMD**: æ²¡æœ‰ç¡¬ä»¶æŒ‡ä»¤æ”¯æŒçœŸæ­£çš„2-wayå¹¶è¡Œ
3. **å¯„å­˜å™¨å‹åŠ›**: 16ä¸ªçŠ¶æ€å˜é‡å ç”¨è¿‡å¤šå¯„å­˜å™¨

**æ•™è®­**: 
> ğŸ’¡ æ²¡æœ‰ç¡¬ä»¶SIMDæ”¯æŒçš„"å¹¶è¡Œ"åªæ˜¯å¢åŠ å¤æ‚åº¦ï¼Œåè€Œé™ä½æ€§èƒ½

#### âŒ AVX2 W[80]æ¶ˆæ¯è°ƒåº¦å‘é‡åŒ– (SHA-512)
**å°è¯•**: ç”¨AVX2ä¸€æ¬¡æ€§è®¡ç®—4ä¸ªWå€¼

```cpp
alignas(64) uint64_t W[80];  // å®Œæ•´å±•å¼€640å­—èŠ‚

for (int i = 16; i < 80; i += 4) {
    __m256i w_16 = _mm256_loadu_si256(&W[i-16]);
    __m256i sig0 = /* å‘é‡åŒ–SIG0 */;
    __m256i sig1 = /* å‘é‡åŒ–SIG1 */;
    __m256i result = _mm256_add_epi64(/* ... */);
    _mm256_storeu_si256(&W[i], result);
}
```

**ç»“æœ**: **æƒ¨ç—›å¤±è´¥** -43.97% (ä»-12.04%æš´è·Œ)

**å¤±è´¥åŸå› **:
1. **Cacheæ€æ‰‹**: W[80] 640å­—èŠ‚ >> W[16] 128å­—èŠ‚
   - ç ´åL1ç¼“å­˜å±€éƒ¨æ€§
   - Cache misså¼€é”€ >> SIMDåŠ é€Ÿæ”¶ç›Š
2. **å†…å­˜è®¿é—®æ¨¡å¼å·®**: éå¯¹é½`loadu`æ•ˆç‡ä½
3. **ä¾èµ–é“¾æœªä¼˜åŒ–**: 4-wayå¹¶è¡Œçš„æ•°æ®ä¾èµ–æ²¡æœ‰çœŸæ­£åŠ é€Ÿ

**æ•™è®­**:
> ğŸ’¡ **Cache > SIMD**: ç¼“å­˜å‹å¥½æ€§ä¼˜å…ˆäºSIMDå¹¶è¡Œåº¦  
> ğŸ’¡ å†…å­˜è®¿é—®æ¨¡å¼æ¯”è®¡ç®—ä¼˜åŒ–æ›´é‡è¦

#### âŒ SHA3-256 Keccak Theta AVX2å‘é‡åŒ–
**å°è¯•**: å‘é‡åŒ–Keccakç½®æ¢çš„thetaæ­¥éª¤

**ç»“æœ**: -75%æ€§èƒ½ä¸‹é™

**å¤±è´¥åŸå› **:
1. Keccakçš„5x5çŠ¶æ€æ•°ç»„ä¸é€‚åˆ256-bitå‘é‡
2. ç½®æ¢æ­¥éª¤çš„å¤æ‚ä¾èµ–å…³ç³»éš¾ä»¥å‘é‡åŒ–
3. å‘é‡shuffleå¼€é”€ > è®¡ç®—åŠ é€Ÿ

**æ•™è®­**:
> ğŸ’¡ ä¸æ˜¯æ‰€æœ‰ç®—æ³•éƒ½é€‚åˆSIMDï¼Œç®—æ³•ç»“æ„å†³å®šä¼˜åŒ–æ–¹å‘

---

## ğŸ”¬ æŠ€æœ¯æ´å¯Ÿ

### å…³é”®ä¼˜åŒ–åŸåˆ™

1. **Cache > SIMD > ç®—æ³•å¤æ‚åº¦**
   - ç¤ºä¾‹: W[16]å¾ªç¯ vs W[80]å®Œæ•´å±•å¼€
   - L1ç¼“å­˜å‘½ä¸­ >> SIMD 4-wayå¹¶è¡Œ

2. **ç¡¬ä»¶åŠ é€Ÿéœ€è¦çœŸå®æŒ‡ä»¤æ”¯æŒ**
   - SHA-256: SHA-NI (`sha256rnds2`, `sha256msg1/2`) âœ…
   - SHA-512: AVX512-IFMA (`vsha512*`) âŒ C intrinsicsä¸å¯ç”¨
   - è½¯ä»¶SIMDæ¨¡æ‹Ÿæ— æ³•æ›¿ä»£ç¡¬ä»¶æŒ‡ä»¤

3. **é¢„å–è·ç¦»éœ€åŒ¹é…ç¼“å­˜å¤§å°**
   - SHA-256: 4-block (256B) é€‚é…32KB L1
   - è¿‡è¿œé¢„å–æµªè´¹å¸¦å®½ï¼Œè¿‡è¿‘æ— æ³•éšè—å»¶è¿Ÿ

4. **æ‰¹å¤„ç†éœ€å¹³è¡¡ILPä¸ä¾èµ–é“¾**
   - 4-round batching: æå‡ILP âœ…
   - åŒå—å¤„ç†: å¢åŠ ä¾èµ– âŒ

---

## ğŸ“ æ€§èƒ½åˆ†ææ–¹æ³•

### ä½¿ç”¨çš„å·¥å…·

1. **Benchmarkæ¡†æ¶**
   ```cpp
   // é¢„çƒ­10æ¬¡ä¸¢å¼ƒï¼Œæµ‹é‡100æ¬¡å–å¹³å‡
   for (warmup) { /* ... */ }
   auto start = Clock::now();
   for (iterations) { hash_function(data); }
   auto elapsed = Clock::now() - start;
   ```

2. **å¯¹æ¯”åŸºçº¿**: OpenSSL 3.6.0 (Windows MinGW GCC 13)

3. **æ€§èƒ½æŒ‡æ ‡**:
   - ååé‡ (MB/s): 10MBæ•°æ®é›†
   - å°æ•°æ®å»¶è¿Ÿ (1KB): æµ‹å•æ¬¡å“ˆå¸Œæ—¶é—´

### ç“¶é¢ˆè¯†åˆ«

- SHA-256å°æ•°æ®å¿«(+24%)ï¼Œå¤§æ•°æ®æ…¢(-3.44%) â†’ **æ‰¹å¤„ç†/é¢„å–**ç“¶é¢ˆ
- SHA-512å…¨åœºæ™¯æ…¢(-13%) â†’ **ç¡¬ä»¶æŒ‡ä»¤é›†**é™åˆ¶
- BLAKE2bè¶…è¶ŠOpenSSL â†’ **ç®—æ³•è®¾è®¡**ä¼˜åŠ¿

---

## ğŸ“ æœ€ä½³å®è·µ

### å¼€å‘æµç¨‹

1. **å»ºç«‹åŸºçº¿**: å…ˆå®ç°æ­£ç¡®çš„æ ‡é‡ç‰ˆæœ¬
2. **æµ‹è¯•å‘é‡**: NIST/RFCæ ‡å‡†æµ‹è¯•ç”¨ä¾‹100%é€šè¿‡
3. **æ€§èƒ½åˆ†æ**: å¯¹æ¯”OpenSSLæ‰¾ç“¶é¢ˆ
4. **æ¸è¿›ä¼˜åŒ–**: æ¯æ¬¡æ”¹ä¸€ä¸ªå˜é‡ï¼ˆé¢„å–/æ‰¹å¤„ç†/SIMDï¼‰
5. **A/Bæµ‹è¯•**: æ¯æ¬¡ä¼˜åŒ–å‰åå¯¹æ¯”æ€§èƒ½
6. **å›é€€æœºåˆ¶**: å¤±è´¥ç«‹å³`git checkout`

### ç¼–è¯‘ä¼˜åŒ–

```cmake
# GCC/Clang
add_compile_options(
    -O3                        # æœ€é«˜ä¼˜åŒ–çº§åˆ«
    -march=native              # CPUç‰¹å®šæŒ‡ä»¤
    -mtune=native              # è°ƒåº¦ä¼˜åŒ–
    -flto                      # é“¾æ¥æ—¶ä¼˜åŒ–
    -ffast-math                # å¿«é€Ÿæ•°å­¦ï¼ˆécryptoä»£ç ï¼‰
    -maes -msha -mavx2 -mbmi2  # æ˜¾å¼å¯ç”¨SIMD
)
```

### ä»£ç è§„èŒƒ

```cpp
// âœ… æ¨èï¼šç´§å‡‘æ‰¹å¤„ç†å®
#define EXPAND_ROUND_4(i, k) do { \
    EXPAND(i);   ROUND(i, k);   \
    EXPAND(i+1); ROUND(i+1, k+1); \
} while(0)

// âŒ ç¦æ­¢ï¼šè¿‡åº¦å¤æ‚çš„ä¼ªå¹¶è¡Œ
static void transform_avx512_dual(...) {
    // å¤§é‡é‡å¤çŠ¶æ€å˜é‡
}

// âœ… æ¨èï¼šCacheå‹å¥½çš„å°æ•°ç»„
alignas(32) uint64_t W[16];  // 128å­—èŠ‚

// âŒ ç¦æ­¢ï¼šCacheæ€æ‰‹å¤§æ•°ç»„
alignas(64) uint64_t W[80];  // 640å­—èŠ‚
```

---

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### SHA-256 (ç›®æ ‡: >2000 MB/s)
- [x] SHA-NIç¡¬ä»¶åŠ é€Ÿå·²å¯ç”¨
- [x] 4-blockæ‰¹å¤„ç†å·²å®ç°
- [ ] æ¢ç´¢8-blockæ‰¹å¤„ç†ï¼ˆéœ€éªŒè¯cacheå½±å“ï¼‰
- [ ] æ±‡ç¼–ä¼˜åŒ–å…³é”®è·¯å¾„ï¼ˆå¯é€‰ï¼‰

### SHA-512 (ç›®æ ‡: æ¥å—ç°çŠ¶æˆ–æ±‡ç¼–)
- [x] 4-round batchingå·²å®ç°
- [ ] âŒ AVX512-IFMAä¸å¯ç”¨ï¼ˆC intrinsicsé™åˆ¶ï¼‰
- [ ] å¯é€‰: æ‰‹å†™æ±‡ç¼–æ¨¡æ‹ŸOpenSSLï¼ˆéœ€å¤§é‡å·¥ä½œï¼‰
- [ ] å»ºè®®: æ¥å—13%å·®è·ï¼Œä¸“æ³¨å…¶ä»–ç®—æ³•

### SHA3-256 (ç›®æ ‡: >606 MB/s)
- [ ] ä¼˜åŒ–absorb/squeezeæ­¥éª¤ï¼ˆéç½®æ¢ï¼‰
- [ ] æ¢ç´¢Keccakå˜ä½“ä¼˜åŒ–
- [ ] å¯èƒ½è·¯å¾„: æ‰¹é‡absorbå¤šä¸ªè¾“å…¥

### BLAKE2b (ç›®æ ‡: ç»´æŒä¼˜åŠ¿)
- [x] å·²è¶…è¶ŠOpenSSL 19%
- [ ] æœªæ¥: AVX2è¿›ä¸€æ­¥ä¼˜åŒ–

---

## ğŸ“– å‚è€ƒèµ„æ–™

### æ ‡å‡†æ–‡æ¡£
- [FIPS 180-4](https://csrc.nist.gov/publications/detail/fips/180/4/final) - SHA-256/384/512
- [FIPS 202](https://csrc.nist.gov/publications/detail/fips/202/final) - SHA-3
- [RFC 7693](https://tools.ietf.org/html/rfc7693) - BLAKE2
- GM/T 0004-2012 - SM3å›½å¯†æ ‡å‡†

### ä¼˜åŒ–å‚è€ƒ
- Intel SHA Extensions Programming Guide
- OpenSSLæºç  (crypto/sha/*.pl - Perlæ±‡ç¼–ç”Ÿæˆ)
- BLAKE2å®˜æ–¹å®ç° (github.com/BLAKE2/BLAKE2)

---

**æ–‡æ¡£ç»´æŠ¤**: æ¯æ¬¡hashç®—æ³•ä¼˜åŒ–åæ›´æ–°æœ¬æ–‡æ¡£  
**License**: Apache License 2.0
