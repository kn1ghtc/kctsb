# kctsb v3.4.0 é‡æ„è®¡åˆ’

> **ç‰ˆæœ¬**: 3.4.0
> **åˆ›å»ºæ—¶é—´**: 2026-01-15 (Beijing Time, UTC+8)
> **çŠ¶æ€**: è¿›è¡Œä¸­

---

## ğŸ“‹ é‡æ„ç›®æ ‡æ¦‚è¿°

å°† kctsb é¡¹ç›®å®Œå…¨é‡æ„ä¸º **C++ å®ç° + C ABI å°è£…** çš„æ¶æ„ï¼Œè¿½æ±‚æè‡´æ€§èƒ½å’Œæœ€å°å†…å­˜å ç”¨ã€‚

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

| ä¼˜å…ˆçº§ | åŸåˆ™ | æè¿° |
|--------|------|------|
| **P1** | C++ Core + C ABI | C++17 å®ç°æ ¸å¿ƒé€»è¾‘ï¼Œextern "C" å¯¼å‡ºç¨³å®š ABI |
| **P2** | C++17 ç»Ÿä¸€æ ‡å‡† | å…¨é¡¹ç›®ä½¿ç”¨ C++17ï¼Œå¯ç”¨æœ€ä¼˜ç¼–è¯‘å‚æ•° |
| **P3** | å•æ–‡ä»¶å•ç®—æ³• | æ¯ä¸ªç®—æ³•ä¸€ä¸ª .cpp + ä¸€ä¸ª .hï¼Œç¦æ­¢é¢å¤–å°è£…å±‚ |

---

## ğŸ¯ é‡æ„èŒƒå›´

### 1. ç›®å½•ç»“æ„è°ƒæ•´

```
kctsb/
â”œâ”€â”€ include/kctsb/crypto/
â”‚   â”œâ”€â”€ aes.h              # AES-GCM (åˆå¹¶)
â”‚   â”œâ”€â”€ chacha20.h         # ChaCha20-Poly1305 (åˆå¹¶)
â”‚   â”œâ”€â”€ sha256.h           # SHA-256
â”‚   â”œâ”€â”€ sha512.h           # SHA-512
â”‚   â”œâ”€â”€ sha3.h             # SHA3-256/512 (Keccak)
â”‚   â”œâ”€â”€ blake2.h           # BLAKE2b/s
â”‚   â”œâ”€â”€ blake3.h           # BLAKE3
â”‚   â”œâ”€â”€ sm2.h              # SM2 (åˆå¹¶ sm2_enc.h)
â”‚   â”œâ”€â”€ sm3.h              # SM3 (åˆ é™¤ sm3_core.h)
â”‚   â”œâ”€â”€ sm4.h              # SM4 (åˆ é™¤ sm4_core.hpp/sm4_impl.hpp)
â”‚   â”œâ”€â”€ rsa.h              # RSA
â”‚   â”œâ”€â”€ ecc.h              # ECC/ECDSA/ECDH/ECIES
â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/crypto/
â”‚   â”œâ”€â”€ aes.cpp            # AES C++å®ç° + C ABI
â”‚   â”œâ”€â”€ chacha20.cpp       # ChaCha20 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ sha256.cpp         # SHA-256 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ sha512.cpp         # SHA-512 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ sha3.cpp           # SHA3 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ blake2.cpp         # BLAKE2 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ blake3.cpp         # BLAKE3 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ sm2.cpp            # SM2 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ sm3.cpp            # SM3 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ sm4.cpp            # SM4 C++å®ç° + C ABI
â”‚   â”œâ”€â”€ rsa.cpp            # RSA C++å®ç° + C ABI
â”‚   â”œâ”€â”€ ecc.cpp            # ECC C++å®ç° + C ABI (åˆå¹¶ecdh/ecdsa/ecies)
â”‚   â””â”€â”€ ...
```

### 2. éœ€è¦åˆ é™¤çš„æ–‡ä»¶

```
# SM ç³»åˆ—å†—ä½™æ–‡ä»¶
- include/kctsb/crypto/sm/sm2_enc.h
- include/kctsb/crypto/sm/sm3_core.h
- include/kctsb/crypto/sm/sm3_impl.h
- include/kctsb/crypto/sm/sm4_core.hpp
- include/kctsb/crypto/sm/sm4_impl.hpp
- include/kctsb/crypto/sm/sm_util.h
- src/crypto/sm/sm_api.cpp        # å…³é”®: åˆ é™¤è¿™ä¸ªä¸åˆç†çš„APIå°è£…
- src/crypto/sm/sm3.c             # åˆå¹¶åˆ° sm3.cpp
- src/crypto/sm/sm4.cpp           # åˆå¹¶é‡æ„
- src/crypto/sm/sm_util.c

# Hash ç³»åˆ—éœ€è¦åˆå¹¶çš„æ–‡ä»¶
- src/crypto/hash/Keccak.cpp      # åˆå¹¶åˆ° sha3.cpp
- src/crypto/hash/blake2.c        # åˆå¹¶åˆ° blake2.cpp
- src/crypto/hash/chacha20.c      # åˆå¹¶åˆ° ../chacha20.cpp
- src/crypto/hash/sha256.cpp      # åˆå¹¶åˆ° ../sha256.cpp
- src/crypto/hash/sha512.c        # åˆå¹¶åˆ° sha512.cpp
- src/crypto/hash/cmac.cpp        # åˆå¹¶åˆ° mac.cpp
- src/crypto/hash/gmac.cpp        # åˆå¹¶åˆ° mac.cpp
- src/crypto/hash/hmac.cpp        # åˆå¹¶åˆ° mac.cpp

# å†—ä½™å¤´æ–‡ä»¶
- include/kctsb/crypto/hash/blake2_impl.h
- include/kctsb/crypto/hash/chacha20_impl.h
- include/kctsb/crypto/hash/keccak.h  # åˆå¹¶åˆ° sha3.h
```

### 3. éœ€è¦é‡æ„çš„æ¨¡å—

| æ¨¡å— | å½“å‰çŠ¶æ€ | é‡æ„ç›®æ ‡ | ä¼˜å…ˆçº§ |
|------|----------|----------|--------|
| SHA-256 | sha256.cpp + sha.h | sha256.cpp + sha256.h | P1 |
| SHA-512 | sha512.c + sha.h | sha512.cpp + sha512.h | P1 |
| SHA3 | Keccak.cpp + keccak.h | sha3.cpp + sha3.h | P1 |
| BLAKE2 | blake2.c + blake.h | blake2.cpp + blake2.h | P1 |
| SM3 | sm3.c + sm3.h + sm3_core.h | sm3.cpp + sm3.h | P1 |
| SM4 | sm4.cpp + sm_api.cpp + å¤šå¤´æ–‡ä»¶ | sm4.cpp + sm4.h | P1 |
| SM2 | åˆ†æ•£ + sm_api.cpp | sm2.cpp + sm2.h | P1 |
| AES | aes.cpp + aes.h | aes.cpp + aes.h (é‡æ„) | P2 |
| ChaCha20 | chacha20_poly1305.cpp | chacha20.cpp + chacha20.h | P2 |
| RSA | rsa.cpp + rsa.h | rsa.cpp + rsa.h (é‡æ„) | P2 |
| ECC | ecc_curve + ecdh + ecdsa + ecies | ecc.cpp + ecc.h | P2 |

---

## ğŸ“ ä»£ç æ¶æ„è§„èŒƒ

### C++ Core + C ABI æ¨¡æ¿

```cpp
/**
 * @file algorithm.cpp
 * @brief Algorithm - C++ Implementation + C ABI Export
 */

#include "kctsb/crypto/algorithm.h"
#include <array>
#include <cstdint>

// ============================================================================
// C++ Internal Implementation
// ============================================================================
namespace kctsb::internal {

class Algorithm {
public:
    // Template metaprogramming for compile-time optimization
    template<size_t N>
    static constexpr std::array<uint32_t, N> compute_constants() noexcept;

    // Force inline for hot path
    __attribute__((always_inline))
    void process_block(const uint8_t* input, uint8_t* output) noexcept;

    // Zero-copy in-place operation
    void transform_inplace(uint8_t* buffer, size_t len) noexcept;

private:
    // Aligned memory for SIMD
    alignas(32) std::array<uint32_t, 16> state_;
};

} // namespace kctsb::internal

// ============================================================================
// C ABI Export (extern "C")
// ============================================================================
extern "C" {

kctsb_error_t kctsb_algorithm_init(kctsb_algorithm_ctx_t* ctx,
                                    const uint8_t* key, size_t key_len) {
    if (!ctx || !key) {
        return KCTSB_ERROR_INVALID_PARAM;
    }

    try {
        // Use placement new to construct C++ object in C struct
        new (&ctx->internal) kctsb::internal::Algorithm();
        // Initialize...
        return KCTSB_SUCCESS;
    } catch (...) {
        return KCTSB_ERROR_INTERNAL;
    }
}

void kctsb_algorithm_clear(kctsb_algorithm_ctx_t* ctx) {
    if (ctx) {
        // Secure zero memory
        volatile uint8_t* p = reinterpret_cast<volatile uint8_t*>(ctx);
        for (size_t i = 0; i < sizeof(*ctx); ++i) {
            p[i] = 0;
        }
    }
}

} // extern "C"
```

### å¤´æ–‡ä»¶æ¨¡æ¿

```c
/**
 * @file algorithm.h
 * @brief Algorithm Public API
 */

#ifndef KCTSB_CRYPTO_ALGORITHM_H
#define KCTSB_CRYPTO_ALGORITHM_H

#include "kctsb/core/common.h"

#ifdef __cplusplus
extern "C" {
#endif

// Constants
#define KCTSB_ALGORITHM_BLOCK_SIZE 16
#define KCTSB_ALGORITHM_KEY_SIZE 32

// Context structure
typedef struct kctsb_algorithm_ctx_s {
    uint8_t opaque[256];  // Opaque storage for C++ implementation
} kctsb_algorithm_ctx_t;

// C API Functions
KCTSB_API kctsb_error_t kctsb_algorithm_init(kctsb_algorithm_ctx_t* ctx,
                                              const uint8_t* key, size_t key_len);

KCTSB_API kctsb_error_t kctsb_algorithm_process(const kctsb_algorithm_ctx_t* ctx,
                                                  const uint8_t* input, size_t input_len,
                                                  uint8_t* output);

KCTSB_API void kctsb_algorithm_clear(kctsb_algorithm_ctx_t* ctx);

#ifdef __cplusplus
}
#endif

#endif // KCTSB_CRYPTO_ALGORITHM_H
```

---

## ğŸ”§ ç¼–è¯‘ä¼˜åŒ–é…ç½®

### CMake ä¼˜åŒ–å‚æ•°

```cmake
# C++17 å¼ºåˆ¶æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Release æé™ä¼˜åŒ–
if(CMAKE_BUILD_TYPE STREQUAL "Release")
    if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
        add_compile_options(
            # åŸºç¡€ä¼˜åŒ–
            -O3
            -march=native
            -mtune=native
            -ffast-math
            -funroll-loops
            -fomit-frame-pointer
            -flto
            -fPIC

            # å†…å­˜ä¼˜åŒ–
            -fno-rtti              # ç¦ç”¨ RTTIï¼Œå‡å°‘å†…å­˜å ç”¨
            -fno-exceptions        # ç¦ç”¨å¼‚å¸¸ï¼ˆC ABI å±‚å¤„ç†ï¼‰

            # ç¡¬ä»¶åŠ é€Ÿ
            -maes                  # AES-NI
            -mpclmul               # PCLMUL (GCM)
            -msse4.1 -msse4.2      # SSE4
            -mavx2                 # AVX2

            # å®‰å…¨åŠ å›º
            -fstack-protector-strong
            -D_FORTIFY_SOURCE=2
        )
        add_link_options(-flto)
    endif()
endif()
```

### build.sh ä¼˜åŒ–

```bash
# é»˜è®¤æé™ä¼˜åŒ–å‚æ•°
CMAKE_BUILD_TYPE="Release"
OPTIMIZATION_FLAGS="-O3 -march=native -mtune=native -ffast-math -funroll-loops -fomit-frame-pointer -flto -fno-rtti -fno-exceptions"

# ç¡¬ä»¶åŠ é€Ÿæ ‡å¿—
SIMD_FLAGS="-maes -mpclmul -msse4.1 -msse4.2 -mavx2"

# å®Œæ•´ç¼–è¯‘å‘½ä»¤
cmake -B build -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="$OPTIMIZATION_FLAGS $SIMD_FLAGS" \
    -DCMAKE_C_FLAGS="-O3 -march=native -flto" \
    -DKCTSB_BUILD_TESTS=ON \
    -DKCTSB_BUILD_BENCHMARKS=ON
```

---

## âœ… å®æ–½æ¸…å•

### Phase 1: åŸºç¡€è®¾æ–½ (Day 1)

- [ ] æ›´æ–° AGENTS.md å¼€å‘è§„èŒƒï¼ˆä¸‰åŸåˆ™ï¼‰
- [ ] æ›´æ–° CMakeLists.txt ç¼–è¯‘é…ç½®
- [ ] æ›´æ–° scripts/build.sh è„šæœ¬
- [ ] æ›´æ–° version.h åˆ° 3.4.0

### Phase 2: Hash æ¨¡å—é‡æ„ (Day 1-2)

- [ ] é‡æ„ sha256.cpp + sha256.h
- [ ] é‡æ„ sha512.cpp + sha512.h
- [ ] é‡æ„ sha3.cpp + sha3.h (åˆå¹¶ Keccak)
- [ ] é‡æ„ blake2.cpp + blake2.h
- [ ] æ–°å¢ blake3.cpp + blake3.h
- [ ] é‡æ„ hmac.cpp + hmac.h
- [ ] åˆ é™¤å†—ä½™æ–‡ä»¶
- [ ] å®Œå–„ test_hash.cpp å•å…ƒæµ‹è¯•
- [ ] æ›´æ–° benchmark_hash.cpp è¦†ç›–å…¨éƒ¨ hash

### Phase 3: SM ç³»åˆ—é‡æ„ (Day 2-3)

- [ ] é‡æ„ sm3.cpp + sm3.h
- [ ] é‡æ„ sm4.cpp + sm4.h
- [ ] é‡æ„ sm2.cpp + sm2.h
- [ ] åˆ é™¤ sm_api.cpp åŠç›¸å…³å†—ä½™æ–‡ä»¶
- [ ] æ›´æ–° test_sm.cpp

### Phase 4: å¯¹ç§°åŠ å¯†é‡æ„ (Day 3)

- [ ] é‡æ„ aes.cpp + aes.h
- [ ] é‡æ„ chacha20.cpp + chacha20.h
- [ ] æ›´æ–° test_aes.cpp

### Phase 5: éå¯¹ç§°åŠ å¯†é‡æ„ (Day 4)

- [ ] é‡æ„ rsa.cpp + rsa.h
- [ ] é‡æ„ ecc.cpp + ecc.h (åˆå¹¶ ecdh/ecdsa/ecies)
- [ ] æ›´æ–° test_rsa.cpp, test_ecc.cpp

### Phase 6: é«˜çº§å¯†ç å­¦é‡æ„ (Day 4-5)

- [ ] é‡æ„ç™½ç›’å¯†ç æ¨¡å—
- [ ] é‡æ„ç§˜å¯†å…±äº«æ¨¡å—
- [ ] é‡æ„é›¶çŸ¥è¯†è¯æ˜æ¨¡å—
- [ ] é‡æ„åé‡å­å¯†ç æ¨¡å—

### Phase 7: æµ‹è¯•ä¸å‘å¸ƒ (Day 5)

- [ ] è¿è¡Œå…¨é‡å•å…ƒæµ‹è¯•
- [ ] è¿è¡Œå…¨é‡é›†æˆæµ‹è¯•
- [ ] è¿è¡Œå…¨é‡ benchmark
- [ ] åˆ›å»º v3.4.0-release.md
- [ ] æ›´æ–° README.md
- [ ] Git æäº¤å‘å¸ƒ

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

1. **ç¼–è¯‘éªŒè¯**
   - [ ] macOS: GCC/Clang ç¼–è¯‘é›¶è­¦å‘Š
   - [ ] Linux: GCC ç¼–è¯‘é›¶è­¦å‘Š
   - [ ] Windows: MinGW/MSVC ç¼–è¯‘é›¶è­¦å‘Š

2. **æµ‹è¯•éªŒè¯**
   - [ ] å…¨éƒ¨å•å…ƒæµ‹è¯•é€šè¿‡ (ç›®æ ‡: 100+)
   - [ ] å…¨éƒ¨é›†æˆæµ‹è¯•é€šè¿‡
   - [ ] Benchmark æ€§èƒ½ä¸ä½äº v3.3.3

3. **ä»£ç è´¨é‡**
   - [ ] æ¯ä¸ªç®—æ³•: 1 .cpp + 1 .h
   - [ ] æ— é¢å¤– API å°è£…æ–‡ä»¶
   - [ ] C ABI åœ¨å„ç®—æ³• .cpp æ–‡ä»¶å†…å¯¼å‡º

4. **æ–‡æ¡£å®Œæ•´**
   - [ ] AGENTS.md æ›´æ–°
   - [ ] README.md æ›´æ–°
   - [ ] v3.4.0-release.md å‘å¸ƒè¯´æ˜

---

## ğŸ”— å‚è€ƒèµ„æº

- [C++ Core Guidelines](https://isocpp.github.io/CppCoreGuidelines/)
- [NIST FIPS 202 (SHA-3)](https://csrc.nist.gov/publications/detail/fips/202/final)
- [RFC 7693 (BLAKE2)](https://tools.ietf.org/html/rfc7693)
- [GM/T 0003-2012 (SM2)](http://www.gmbz.org.cn/)
