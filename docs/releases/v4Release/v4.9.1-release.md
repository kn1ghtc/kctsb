# kctsb v4.9.1 Release Notes

**Release Date**: 2026å¹´1æœˆ28æ—¥ (UTC+8)  
**Codename**: Harvey NTT + RNSPoly Foundation  

---

## ğŸ¯ ç‰ˆæœ¬æ¦‚è¿°

v4.9.1 å®ç°äº† **Phase 4b FHE ä¼˜åŒ–** çš„æ ¸å¿ƒç»„ä»¶ï¼š

1. **Harvey NTT ç®—æ³•** - å®Œæ•´å®ç° SEAL-style NTT with lazy reduction
2. **RNSPoly ç±»** - ç‹¬ç«‹çš„ RNS å¤šé¡¹å¼åŸºç¡€è®¾æ–½
3. **æ­£ç¡®çš„é€†NTT** - ä¿®å¤äº†å…³é”®çš„ Gentleman-Sande DIF ç´¢å¼•bug
4. **BGV é›†æˆ** - ntt_poly_ops è¿ç§»åˆ° Harvey NTT

æ­¤ç‰ˆæœ¬å»ºç«‹äº†é«˜æ€§èƒ½ FHE çš„åŸºç¡€æ¶æ„ï¼Œå•æ¬¡ NTT è¾¾åˆ° **22Î¼s** (n=4096)ï¼Œæ¥è¿‘ SEAL æ€§èƒ½ã€‚

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. Harvey NTT å®ç° (`ntt_harvey.hpp/cpp`)

å®Œæ•´çš„ SEAL-style Harvey NTT å®ç°ï¼š

**æ ¸å¿ƒç®—æ³•**:
- **Forward NTT**: Cooley-Tukey DIT with bit-reversed twiddle factors
- **Inverse NTT**: Gentleman-Sande DIF with SEAL scrambled order
- **Lazy Reduction**: ç»“æœåœ¨ [0, 2q) èŒƒå›´å†…ï¼Œå»¶è¿Ÿæœ€ç»ˆè§„çº¦

**å…³é”®ä¿®å¤**:
- ä¿®å¤äº†é€†NTTçš„æ•°ç»„è¶Šç•Œbug (åŸå§‹ `j1 += h` å¯¼è‡´ OOB)
- é‡‡ç”¨ SEAL çš„ `gap`/`offset` ç´¢å¼•æ¨¡å¼
- ä¿®å¤äº† `inv_root_powers` çš„ scrambled order å­˜å‚¨

**ç»„ä»¶**:
```cpp
// include/kctsb/advanced/fe/common/ntt_harvey.hpp
class NTTTables;                    // é¢„è®¡ç®—twiddle factors
void ntt_negacyclic_harvey();       // å‰å‘NTT
void inverse_ntt_negacyclic_harvey(); // é€†NTT (å« n^{-1} scaling)
```

### 2. RNSPoly ç±» (`rns_poly.hpp`)

ç‹¬ç«‹çš„ RNS å¤šé¡¹å¼åŸºç¡€è®¾æ–½ï¼Œä¸º EvaluatorV2 åšå‡†å¤‡ï¼š

**ç‰¹æ€§**:
- å¤šå±‚ RNS è¡¨ç¤º (L levels, each mod q_i)
- NTT å˜æ¢æ”¯æŒ (coefficient â†” NTT domain)
- Component-wise ç®—æœ¯è¿ç®— (add, sub, multiply)
- RNSContext ç®¡ç† NTT tables å’Œå‚æ•°

**API**:
```cpp
class RNSContext;   // å‚æ•°ç®¡ç†å’ŒNTT tables
class RNSPoly;      // RNSå¤šé¡¹å¼ï¼Œæ”¯æŒ ntt_transform()/intt_transform()

// å¤šé¡¹å¼ä¹˜æ³•
RNSPoly poly_multiply(const RNSPoly& a, const RNSPoly& b);
```

### 3. ntt_poly_ops è¿ç§»

`ntt_poly_ops.cpp` å®Œå…¨è¿ç§»åˆ° Harvey NTTï¼š

**æ”¹åŠ¨**:
- `multiply_poly_ntt()` ç°åœ¨ä½¿ç”¨ `ntt_negacyclic_harvey()`
- `to_ntt_form()`/`from_ntt_form()` ä½¿ç”¨ Harvey NTT
- å†…éƒ¨ç¼“å­˜ä½¿ç”¨ `NTTTablesCache`
- æ¨¡è¿ç®—ä½¿ç”¨ `modular_ops.hpp` (Modulus class)

---

## ğŸš€ æ€§èƒ½æ•°æ®

### NTT æ ¸å¿ƒæ€§èƒ½

| æ“ä½œ | å‚æ•° | æ—¶é—´ | å¯¹æ¯” SEAL |
|------|------|------|-----------|
| Single NTT | n=4096 | 22 Î¼s | ~10 Î¼s |
| RNS Poly multiply | n=4096, L=10 | 675 Î¼s | - |
| Poly multiply | n=1024, L=3 | 72 Î¼s | - |

### åŠ é€Ÿæ¯”

| ç®—æ³• | NTT | Schoolbook | åŠ é€Ÿæ¯” |
|------|-----|------------|--------|
| N=256 | 5.3 Î¼s | 567 Î¼s | **107x** |

### BGV ç°çŠ¶ (å¾…ä¼˜åŒ–)

| æ“ä½œ | n=8192 | ç›®æ ‡ | SEAL |
|------|--------|------|------|
| Multiply | 1335 ms | <100 ms | ~10 ms |

**è¯´æ˜**: BGV æ…¢çš„åŸå› æ˜¯ ZZ_pX â†” uint64_t è½¬æ¢å’Œ CRT é‡æ„å¼€é”€ã€‚Phase 4c å°†ä½¿ç”¨ RNSPoly é‡å†™ EvaluatorV2ã€‚

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

- **æ€»æµ‹è¯•**: 409 tests (100% pass)
- **NTT Harvey**: 27/27 pass (1 DISABLED: AVX2 forward)
- **NTT Poly Ops**: 22/22 pass  
- **RNS Poly**: 9/9 pass
- **BGV**: 43/43 pass
- **BFV**: 26/26 pass
- **CKKS**: 33/33 pass

---

## ğŸ“ æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶
- `include/kctsb/advanced/fe/common/ntt_harvey.hpp` - Harvey NTT å£°æ˜
- `include/kctsb/advanced/fe/common/modular_ops.hpp` - æ¨¡è¿ç®— (Modulus, Barrett)
- `include/kctsb/advanced/fe/common/rns_poly.hpp` - RNSPoly ç±»
- `src/advanced/fe/common/ntt_harvey.cpp` - Harvey NTT å®ç°
- `tests/test_ntt_harvey.cpp` - 28 ä¸ªæµ‹è¯•ç”¨ä¾‹

### ä¿®æ”¹æ–‡ä»¶
- `src/advanced/fe/common/ntt_poly_ops.cpp` - è¿ç§»åˆ° Harvey NTT
- `include/kctsb/advanced/fe/common/ntt_poly_ops.hpp` - æ¥å£ä¸å˜

---

## âš ï¸ å·²çŸ¥é—®é¢˜

1. **AVX2 Forward NTT Bug**: `ntt_negacyclic_harvey_avx2()` äº§ç”Ÿé”™è¯¯ç»“æœ
   - å·²ä¸´æ—¶ç¦ç”¨ (æµ‹è¯•æ ‡è®°ä¸º DISABLED)
   - RNSPoly ä½¿ç”¨æ ‡é‡ç‰ˆæœ¬ (åŠŸèƒ½æ­£ç¡®)
   - æ€§èƒ½å½±å“è¾ƒå° (æ ‡é‡ç‰ˆå·²å¾ˆå¿«)

2. **BGV æ€§èƒ½ç“¶é¢ˆ**: åŒæ€ä¹˜æ³•ä»éœ€ 1335ms
   - æ ¹å› : ZZ_pX â†” uint64_t è½¬æ¢å¼€é”€
   - è§£å†³æ–¹æ¡ˆ: Phase 4c ç”¨ RNSPoly é‡å†™ EvaluatorV2

---

## ğŸ”® ä¸‹ä¸€æ­¥è®¡åˆ’ (Phase 4c)

1. **BGV EvaluatorV2** - åŸºäº RNSPoly çš„åŸç”Ÿå®ç°
   - ç§»é™¤ ZZ_pX ä¾èµ–
   - å…¨ç¨‹ä¿æŒ NTT domain
   - ç›®æ ‡: Multiply < 20ms

2. **AVX2 NTT ä¿®å¤** - ä¿®å¤ forward NTT çš„ç´¢å¼•é—®é¢˜

3. **Key Switching ä¼˜åŒ–** - RNS decomposition with NTT

---

## ğŸ“Š æ„å»ºéªŒè¯

```bash
# Configure
cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

# Build
cmake --build build --parallel

# Test
ctest --test-dir build --output-on-failure
# 100% tests passed, 0 tests failed out of 409
```

---

## ğŸ“ å˜æ›´æ—¥å¿—

- [NEW] Harvey NTT å®Œæ•´å®ç° (forward + inverse)
- [NEW] RNSPoly ç±»å’Œ RNSContext
- [NEW] NTTTables é¢„è®¡ç®— twiddle factors (bit-reversed order)
- [NEW] modular_ops.hpp æ¨¡è¿ç®—åŸºç¡€è®¾æ–½
- [FIX] é€†NTT æ•°ç»„è¶Šç•Œ bug (Gentleman-Sande DIF ç´¢å¼•)
- [FIX] inv_root_powers scrambled order (SEAL å…¼å®¹)
- [OPTIMIZE] ntt_poly_ops è¿ç§»åˆ° Harvey NTT (107x åŠ é€Ÿ)
- [DISABLED] AVX2 forward NTT (å¾…ä¿®å¤)

---

**Full Changelog**: v4.9.0...v4.9.1
