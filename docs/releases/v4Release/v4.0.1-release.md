# KCTSB v4.0.1 Release Notes

**Release Date**: 2025-01-15 (UTC+8)  
**Type**: Hotfix Release

## üêõ Bug Fixes

### Critical: GMP Nail Bits Configuration Mismatch

**Issue**: SM2 cryptographic operations (sign/verify/encrypt/decrypt) were returning `KCTSB_ERROR_INVALID_KEY (-4)`.

**Root Cause**: Mismatch between kctsb's assumed nail bits configuration and GMP's actual configuration:

| Configuration | kctsb (Old) | GMP (Actual) | kctsb (Fixed) |
|---------------|-------------|--------------|---------------|
| `*_ZZ_NBITS` | 60 | 64 | 64 |
| `*_NAIL_BITS` | 4 | 0 | 0 |

**Technical Analysis**:
- The bignum code (migrated from NTL) originally reserved 4 "nail bits" per 64-bit limb for carry detection
- GMP does NOT use nail bits (`GMP_NAIL_BITS = 0`), using full 64-bit limbs
- The bit counting function `_kctsb_g2log()` calculated: `KCTSB_ZZ_NBITS * (limbs-1) + remainder`
- With `KCTSB_ZZ_NBITS=60` but GMP using 64 bits, this caused 4 bits lost per limb
- For 256-bit SM2 curve parameters: 4 limbs √ó 4 lost bits = ~12 bits lost (256 ‚Üí 244 bits)

**Files Modified**:
- `include/kctsb/math/bignum/mach_desc.h` - Set `KCTSB_ZZ_NBITS=64` when `KCTSB_GMP_LIP` defined
- `include/kctsb/math/bignum/gmp_aux.h` - Added verification for GMP_NUMB_BITS consistency
- `include/kctsb/math/bignum/kctsb_bignum_config.h` - Synchronized nail bits configuration

### GF2X Include Path Conflict

**Issue**: GF2X headers conflicting with system headers (e.g., `gf2x/gf2x.h` vs system `gf2x.h`)

**Solution**: Adjusted CMake include order to prioritize thirdparty GF2X headers.

## ‚úÖ Test Results

```
100% tests passed, 0 tests failed out of 169
```

All cryptographic modules now working correctly:
- ‚úÖ SM2 (10 tests) - Sign/Verify/Encrypt/Decrypt
- ‚úÖ RSA (21 tests) - Key generation/Sign/Verify/Encrypt/Decrypt
- ‚úÖ ECC (15 tests) - Curve operations
- ‚úÖ AES/ChaCha20/Poly1305 (48 tests)
- ‚úÖ Math/BigNum (38 tests) - ZZ/GF2X operations

## üîß Build & Test

```powershell
cd D:\pyproject\kctsb

# Full rebuild recommended after this fix
cmake -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DKCTSB_BUILD_TESTS=ON
cmake --build build --parallel --clean-first

# Run all tests
ctest --test-dir build --output-on-failure
```

## üìä Configuration Verification

After building, the configuration should show:
```
KCTSB_BITS_PER_LIMB_T: 64
KCTSB_ZZ_NBITS: 64
KCTSB_NAIL_BITS: 0
GMP_NUMB_BITS: 64
GMP_NAIL_BITS: 0
```

## ‚ö†Ô∏è Upgrade Notes

If upgrading from v4.0.0:
1. Delete the `build/` directory
2. Reconfigure and rebuild from scratch
3. All SM2 operations will work correctly after rebuild

---
*KCTSB v4.0.1 - GMP Compatibility Hotfix*
