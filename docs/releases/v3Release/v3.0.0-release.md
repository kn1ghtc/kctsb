# kctsb v3.0.0 Release Notes

**Release Date**: 2026-01-12 (Beijing Time, UTC+8)
**Version**: 3.0.0
**Type**: Major Release

---

## ğŸ¯ Overview

kctsb v3.0.0 æ˜¯ä¸€ä¸ªé‡Œç¨‹ç¢‘ç‰ˆæœ¬ï¼Œå°†åº“ä»æ•™è‚²ç”¨é€”å‡çº§ä¸ºç”Ÿäº§çº§å¯†ç å­¦å·¥å…·åº“ã€‚æ­¤ç‰ˆæœ¬ä¸“æ³¨äºå®‰å…¨æ€§å¢å¼ºã€ä¾§ä¿¡é“é˜²æŠ¤å’Œç°ä»£ AEAD å¯†ç æ”¯æŒã€‚

## âš ï¸ Breaking Changes

### å·²ç§»é™¤ä¸å®‰å…¨æ¨¡å¼
- **AES-ECB** æ¨¡å¼å·²æ°¸ä¹…ç§»é™¤ï¼ˆæ— æ³•å®‰å…¨ä½¿ç”¨ï¼‰
- **AES-CBC** æ¨¡å¼å·²ç§»é™¤ï¼ˆå»ºè®®ä½¿ç”¨ AES-GCM æ›¿ä»£ï¼‰
- æ—§çš„ `kctsb_aes_cbc_encrypt` / `kctsb_aes_cbc_decrypt` API å·²åˆ é™¤

### API å˜æ›´
- `kctsb_secure_compare` è¿”å›å€¼è¯­ä¹‰å˜æ›´ï¼š
  - ç°åœ¨è¿”å› `1` è¡¨ç¤ºç›¸ç­‰ï¼ˆtrueï¼‰
  - è¿”å› `0` è¡¨ç¤ºä¸ç›¸ç­‰ï¼ˆfalseï¼‰
  - è¿™æ¯” memcmp çš„è¯­ä¹‰æ›´ç›´è§‚

### å¤´æ–‡ä»¶é‡ç»„
- å®‰å…¨åŸè¯­ç§»è‡³ `kctsb/core/security.h`
- `kctsb_random_bytes` å‡½æ•°ç°åœ¨åœ¨ `security.h` ä¸­å£°æ˜

## âœ¨ New Features

### 1. AES-GCM AEAD å®Œæ•´å®ç°
- RFC 5116 å…¼å®¹çš„ Galois/Counter Mode
- å®Œæ•´çš„ GHASH å¤šé¡¹å¼ä¹˜æ³•å®ç°
- æ”¯æŒæµå¼åŠ å¯†/è§£å¯† API
- æ”¯æŒ AADï¼ˆé¢å¤–è®¤è¯æ•°æ®ï¼‰
- 128-bit è®¤è¯æ ‡ç­¾

```cpp
// å•æ¬¡è°ƒç”¨ API
kctsb_aes_gcm_encrypt(&ctx, iv, iv_len, aad, aad_len, 
                       plaintext, pt_len, ciphertext, tag);

// æµå¼ API
kctsb_aes_gcm_init(&gcm_ctx, &aes_ctx, iv, iv_len);
kctsb_aes_gcm_update_aad(&gcm_ctx, aad, aad_len);
kctsb_aes_gcm_update_encrypt(&gcm_ctx, plaintext, ciphertext, len);
kctsb_aes_gcm_final_encrypt(&gcm_ctx, tag);
```

### 2. ChaCha20-Poly1305 AEAD
- RFC 8439 å®Œå…¨å…¼å®¹
- ChaCha20 æµå¯†ç ï¼ˆ256-bit å¯†é’¥ï¼Œ96-bit nonceï¼‰
- Poly1305 MACï¼ˆ128-bit æ ‡ç­¾ï¼‰
- è½¯ä»¶ä¼˜åŒ–çš„å¸¸é‡æ—¶é—´å®ç°

```cpp
kctsb_chacha20_poly1305_encrypt(key, nonce, aad, aad_len,
                                 plaintext, pt_len, ciphertext, tag);
kctsb_chacha20_poly1305_decrypt(key, nonce, aad, aad_len,
                                 ciphertext, ct_len, tag, plaintext);
```

### 3. å®‰å…¨æ ¸å¿ƒåº“ (security.h/.c)
- **å¸¸é‡æ—¶é—´æ¯”è¾ƒ** - é˜²æ­¢æ—¶åºæ”»å‡»
- **å¸¸é‡æ—¶é—´æ¡ä»¶é€‰æ‹©** - `kctsb_ct_select(condition, a, b)`
- **å¸¸é‡æ—¶é—´äº¤æ¢** - `kctsb_ct_swap(condition, &a, &b)`
- **å®‰å…¨å†…å­˜æ¸…é›¶** - ä¿è¯ä¸ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰
- **å¹³å° CSPRNG** - Windows BCrypt / Linux getrandom / macOS SecRandom

### 4. æ–°é”™è¯¯ç 
- `KCTSB_ERROR_AUTH_FAILED` - AEAD è®¤è¯å¤±è´¥
- `KCTSB_ERROR_RANDOM_FAILED` - éšæœºæ•°ç”Ÿæˆå¤±è´¥
- `KCTSB_ERROR_SECURITY_CHECK` - å®‰å…¨æ£€æŸ¥å¤±è´¥

### 5. å®‰å…¨ç¯å¢ƒæ£€æµ‹
```cpp
uint32_t flags = kctsb_security_check();
if (flags & KCTSB_SEC_ASLR_ENABLED) { /* ASLR active */ }
if (flags & KCTSB_SEC_RANDOM_AVAILABLE) { /* CSPRNG available */ }
```

## ğŸ”’ Security Enhancements

### ä¾§ä¿¡é“é˜²æŠ¤
- æ‰€æœ‰å¯†ç æ“ä½œä½¿ç”¨å¸¸é‡æ—¶é—´ç®—æ³•
- æ¶ˆé™¤æ•°æ®ç›¸å…³çš„åˆ†æ”¯å’Œå†…å­˜è®¿é—®æ¨¡å¼
- ç¼–è¯‘å™¨å†…å­˜å±éšœé˜²æ­¢é‡æ’åº
- å¯†é’¥å’Œæ•æ„Ÿæ•°æ®ä½¿ç”¨å®‰å…¨æ¸…é›¶

### å†…å­˜å®‰å…¨
- `SecureBuffer<T>` C++ æ¨¡æ¿è‡ªåŠ¨å®‰å…¨æ¸…é›¶
- `kctsb_secure_zero` ä¿è¯å†™å…¥æ‰§è¡Œ
- è¾“å…¥éªŒè¯å’Œè¾¹ç•Œæ£€æŸ¥

### ç°ä»£ AEAD ä¼˜å…ˆ
- æ¨èä½¿ç”¨ AES-GCM æˆ– ChaCha20-Poly1305
- è®¤è¯åŠ å¯†é˜²æ­¢å¯†æ–‡ç¯¡æ”¹
- æ”¯æŒé¢å¤–è®¤è¯æ•°æ® (AAD)

## ğŸ“¦ Platform Support

- **Windows**: BCryptGenRandom CSPRNG, SecureZeroMemory
- **Linux**: getrandom() syscall, /dev/urandom fallback
- **macOS**: SecRandomCopyBytes, arc4random_buf fallback

### Compiler Requirements
- GCC 13+ / Clang 16+ / MSVC 2022+
- C11 / C++17 æ ‡å‡†

## ğŸ“ File Changes

### New Files
- `include/kctsb/core/security.h` - å®‰å…¨åŸè¯­å¤´æ–‡ä»¶
- `src/core/security.c` - å®‰å…¨åŸè¯­å®ç°
- `include/kctsb/crypto/chacha20_poly1305.h` - ChaCha20-Poly1305 å¤´æ–‡ä»¶
- `src/crypto/chacha20/chacha20_poly1305.cpp` - ChaCha20-Poly1305 å®ç°

### Modified Files
- `include/kctsb/crypto/aes.h` - ç§»é™¤ CBCï¼Œæ·»åŠ å®Œæ•´ GCM API
- `src/crypto/aes/aes.cpp` - GCM å®ç°é‡å†™
- `include/kctsb/core/common.h` - æ–°é”™è¯¯ç ï¼Œæ ‡è®° ECB/CBC deprecated
- `CMakeLists.txt` - ç‰ˆæœ¬ 3.0.0ï¼Œæ·»åŠ  ChaCha20 æºæ–‡ä»¶
- `include/kctsb/kctsb.h` - ç‰ˆæœ¬å·æ›´æ–°

### Removed Code
- `kctsb_aes_cbc_encrypt` / `kctsb_aes_cbc_decrypt`
- ECB æ¨¡å¼ç›¸å…³ä»£ç 

## ğŸ§ª Testing

å…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼š
- `test_integration` - 4/4 é€šè¿‡
- `test_aes` - 7/7 é€šè¿‡ï¼ˆåŒ…æ‹¬æ–°çš„ GCM æµ‹è¯•ï¼‰
- `test_hash` - å…¨éƒ¨é€šè¿‡
- `test_sm` - å…¨éƒ¨é€šè¿‡

## ğŸ”„ Migration Guide

### ä» CBC è¿ç§»åˆ° GCM

**ä¹‹å‰ (v2.x)**:
```cpp
kctsb_aes_cbc_encrypt(&ctx, iv, plaintext, len, ciphertext, &out_len);
```

**ä¹‹å (v3.0.0)**:
```cpp
uint8_t tag[16];
kctsb_aes_gcm_encrypt(&ctx, iv, 12, NULL, 0, 
                       plaintext, len, ciphertext, tag);
// éœ€è¦å­˜å‚¨ tag ä»¥ä¾¿è§£å¯†æ—¶éªŒè¯
```

### æ›´æ–° secure_compare è°ƒç”¨

**ä¹‹å‰**:
```cpp
if (kctsb_secure_compare(a, b, len) == 0) { /* equal */ }
```

**ä¹‹å**:
```cpp
if (kctsb_secure_compare(a, b, len) == 1) { /* equal */ }
// æˆ–æ›´ç›´è§‚çš„:
if (kctsb_secure_compare(a, b, len)) { /* equal */ }
```

## ğŸ“‹ Dependencies

æ­¤ç‰ˆæœ¬ä¸ä¾èµ– OpenSSLï¼Œå®Œå…¨ä½¿ç”¨å†…éƒ¨å®ç°ã€‚

å¯é€‰ä¾èµ–ï¼š
- NTL (Number Theory Library) - å¤§æ•´æ•°å’Œå¤šé¡¹å¼è¿ç®—
- GMP - é«˜æ€§èƒ½ä»»æ„ç²¾åº¦ç®—æœ¯

---

**Full Changelog**: v2.0.0...v3.0.0
