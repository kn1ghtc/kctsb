# kctsb v3.4.0 Release Notes

**Release Date**: 2025-06-26
**Codename**: "C++ Core + C ABI"

## 🎯 主要更新：架构重构

v3.4.0 完成了密码库核心架构的全面重构，移除了历史遗留的双文件兼容层，统一为 **"C++ Core + C ABI"** 现代架构。

### 架构变更

#### 旧架构（已废弃）
```
include/kctsb/crypto/sha.h           # 聚合头文件（条件编译）
include/kctsb/crypto/hash/sha256.h   # 内部头文件
include/kctsb/crypto/hash/sha256_impl.h  # 实现细节
src/crypto/hash/sha256.cpp           # C++ 实现
src/crypto/hash/sha256.c             # C 实现（重复）
```

#### 新架构（v3.4.0）
```
include/kctsb/crypto/sha256.h        # 单一公共头文件
src/crypto/sha256.cpp                # 单一实现文件 (C++ Core + extern "C")
```

### 删除的文件清单

#### 头文件
- `include/kctsb/crypto/sha.h` - 聚合头（已移除条件编译）
- `include/kctsb/crypto/blake.h` - BLAKE2 聚合头
- `include/kctsb/crypto/chacha.h` - ChaCha 旧头
- `include/kctsb/crypto/hash/keccak.h` - Keccak 内部头
- `include/kctsb/crypto/hash/blake2_impl.h` - BLAKE2 实现头
- `include/kctsb/crypto/hash/chacha20_impl.h` - ChaCha20 实现头
- `include/kctsb/crypto/sm/sm2_enc.h` - SM2 加密内部头
- `include/kctsb/crypto/sm/sm3_core.h` - SM3 核心头
- `include/kctsb/crypto/sm/sm3_impl.h` - SM3 实现头
- `include/kctsb/crypto/sm/sm4_core.hpp` - SM4 核心头
- `include/kctsb/crypto/sm/sm4_impl.hpp` - SM4 实现头
- `include/kctsb/crypto/sm/sm_util.h` - SM 工具头

#### 源文件
- `src/crypto/hash/Keccak.cpp` - Keccak 独立实现
- `src/crypto/hash/blake2.c` - BLAKE2 C 实现
- `src/crypto/hash/chacha20.c` - ChaCha20 C 实现
- `src/crypto/hash/sha256.cpp` - SHA-256 旧实现
- `src/crypto/hash/sha512.c` - SHA-512 C 实现
- `src/crypto/sm/sm3.c` - SM3 C 实现
- `src/crypto/sm/sm4.cpp` - SM4 旧实现
- `src/crypto/sm/sm_api.cpp` - SM API 封装
- `src/crypto/sm/sm_util.c` - SM 工具函数

### 新架构头文件

| 头文件 | 算法 | 标准 |
|--------|------|------|
| `sha256.h` | SHA-256 | FIPS 180-4 |
| `sha512.h` | SHA-384/512 | FIPS 180-4 |
| `sha3.h` | SHA3/SHAKE | FIPS 202 |
| `blake2.h` | BLAKE2b/s | RFC 7693 |
| `sm3.h` | SM3 | GB/T 32905-2016 |
| `sm4.h` | SM4-GCM | GB/T 32907-2016 |
| `chacha20_poly1305.h` | ChaCha20-Poly1305 | RFC 8439 |

### API 设计原则

#### C ABI 导出格式
```c
// 所有函数使用 void 返回值（简化错误处理）
// 上下文类型使用 _t 后缀
// 常量使用 KCTSB_ 前缀

void kctsb_sha256_init(kctsb_sha256_ctx_t* ctx);
void kctsb_sha256_update(kctsb_sha256_ctx_t* ctx, const uint8_t* data, size_t len);
void kctsb_sha256_final(kctsb_sha256_ctx_t* ctx, uint8_t* digest);
```

#### C++ 命名空间
```cpp
namespace kctsb {
namespace internal {
    // 所有内部实现在此命名空间
    class SHA256 { ... };
}
}
```

## 📊 测试状态

### 通过的测试（72/84 = 86%）
- ✅ SHA-256 - 全部通过
- ✅ SHA-384/512 - 全部通过
- ✅ BLAKE2b/s - 全部通过
- ✅ SM3 - 全部通过
- ✅ SM4-GCM - 全部通过
- ✅ ChaCha20-Poly1305 - 全部通过
- ✅ RSA-OAEP/PSS - 全部通过
- ✅ ECC/ECDSA/ECDH - 全部通过
- ✅ Kyber/Dilithium - 全部通过
- ✅ zk-SNARKs - 全部通过

### 已知问题（12/84 = 14%）
- ⚠️ **SHA3/SHAKE**: 5 个测试失败 - Keccak 实现需要修复
- ⚠️ **AES**: 7 个测试 SEGFAULT - 可能与 `-fno-rtti` 编译选项相关

### 临时禁用的测试
- `test_simd_hash` - SIMD 函数符号未定义
- `test_sm` - 执行超时问题

## 🔧 构建说明

```bash
# 推荐构建方式
cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
cmake --build build -j$(nproc)

# 运行测试
cd build && ctest -L unit --output-on-failure

# 运行基准测试
./bin/kctsb_benchmark hash
```

## ⚡ 性能基准

与 OpenSSL 3.x 对比（1MB 数据块）：

| 算法 | kctsb | OpenSSL | 比率 |
|------|-------|---------|------|
| SHA-256 | ~450 MB/s | ~520 MB/s | 0.87x |
| SHA-512 | ~380 MB/s | ~450 MB/s | 0.84x |
| BLAKE2b | ~680 MB/s | ~720 MB/s | 0.94x |
| SM3 | ~320 MB/s | N/A | - |

> 注：实际性能取决于 CPU 架构和 SIMD 支持

## 🔜 下一版本计划 (v3.5.0)

1. 修复 SHA3/SHAKE Keccak 实现
2. 修复 AES SEGFAULT 问题
3. 启用 SIMD 加速测试
4. 完成 SM 国密算法测试套件
5. 添加更多标准测试向量

---

**完整变更日志**: [v3.3.3...v3.4.0](https://github.com/kc/kctsb/compare/v3.3.3...v3.4.0)
