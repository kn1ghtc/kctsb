# kctsb v4.6.0 Phase 2 è®¾è®¡æ–‡æ¡£ - BFV + æ€§èƒ½ä¼˜åŒ–

> **ç‰ˆæœ¬**: v4.6.0 Phase 2  
> **æ—¥æœŸ**: 2026-01-22 (Beijing Time, UTC+8)  
> **çŠ¶æ€**: ğŸ”„ å®æ–½ä¸­ | æ›´æ–°äº 2026-01-22 18:30

---

## 0. Phase 1 é—ç•™é—®é¢˜åˆ†æ

### æœ€æ–° Benchmark ç»“æœ (2026-01-22 18:00 ä¿®å¤å)

| æ“ä½œ | kctsb (ms) | SEAL å‚è€ƒ (ms) | å·®è· | çŠ¶æ€ |
|------|-----------|----------------|------|------|
| KeyGen (SK+PK) | 1,312 | ~50 | 26x | â³ å¾…ä¼˜åŒ– |
| Relin key gen | 4,906 | ~50 | 98x | â³ å¾…ä¼˜åŒ– |
| Encrypt | 2,625 | ~5 | 525x | â³ å¾…ä¼˜åŒ– |
| Decrypt | 1,281 | ~2 | 640x | â³ å¾…ä¼˜åŒ– |
| Add | 0.7 | 0.1 | 7x | âœ… å¯æ¥å— |
| **Multiply** | **10,961** | ~10 | 1,096x | ğŸ”§ å·²ä¿®å¤æ­£ç¡®æ€§ (NTT ç¦ç”¨) |
| Mod switch | 12.1 | ~1 | 12x | â³ å¾…ä¼˜åŒ– |

**éªŒè¯ç»“æœ**:
- âœ… Addition correctness: PASS
- âœ… Multiplication correctness: PASS  
- âœ… Fresh ciphertext noise: 89.3 bits
- âœ… After multiplication noise: 50.7 bits (å¥åº·)
- âœ… 41/41 BGV tests passed (100%)

### å…³é”®é—®é¢˜å®šä½ä¸ä¿®å¤è®°å½•

#### é—®é¢˜ 1: NTT ä¹˜æ³•åœ¨å¤§ç´ æ•°ä¸‹å¤±è´¥ âš ï¸ å·²ä¸´æ—¶ç¦ç”¨

**ç—‡çŠ¶**: n=8192 æ—¶ `Multiplication correctness: FAIL`, å™ªå£°é¢„ç®—çˆ†ç‚¸è‡³ 0.0 bits

**æ ¹å› åˆ†æ**:
- NTT å•å…ƒæµ‹è¯• (54 ä¸ª) ä½¿ç”¨ ~20-bit å°ç´ æ•°å…¨éƒ¨é€šè¿‡
- BGV å®é™…ä½¿ç”¨ ~50-bit å¤§ç´ æ•°æ—¶ RNS-NTT-CRT é‡æ„å¤±è´¥
- Schoolbook ä¹˜æ³•åœ¨åŒæ ·å‚æ•°ä¸‹ç»“æœæ­£ç¡®

**è¯Šæ–­å®éªŒ**:
```
TOY_PARAMS (n=256, schoolbook): single_multiply = 42 âœ…
SECURITY_128 (n=8192, NTT): single_multiply = -19208 âŒ
SECURITY_128 (n=8192, schoolbook): single_multiply = 42 âœ…
```

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**: 
```cpp
// src/advanced/fe/bgv/bgv_evaluator.cpp:312
// TODO: Fix NTT multiplication for large (50-bit) primes
// NTT unit tests pass with small primes (~20 bits) but fail with large primes
bool use_ntt = false;  // Disabled until fix
```

**TODO**: éœ€è¦è°ƒæŸ¥ `multiply_rns_ntt_crt()` å’Œç›¸å…³ CRT é‡æ„å‡½æ•°åœ¨å¤§ç´ æ•°ä¸‹çš„æº¢å‡ºé—®é¢˜

#### é—®é¢˜ 2: Batch SIMD ç¼–ç ä¸æ”¯æŒä¹˜æ³• âš ï¸ è®¾è®¡é™åˆ¶

**ç—‡çŠ¶**: æ‰¹é‡ç¼–ç çš„å‘é‡ç›¸ä¹˜å¾—åˆ°é”™è¯¯ç»“æœ

**æ ¹å› **: å½“å‰ batch encoding æ˜¯ç®€å•çš„ç³»æ•°ç¼–ç ï¼Œä¸æ˜¯åŸºäº CRT çš„çœŸæ­£ SIMD packing

**è§£å†³æ–¹æ¡ˆ**: Benchmark æ”¹ç”¨å•å€¼ç¼–ç éªŒè¯æ­£ç¡®æ€§
```cpp
// ä¿®å¤å‰ (é”™è¯¯)
auto pt1 = encoder.encode_batch({7, 5, 3, 1});
auto pt2 = encoder.encode_batch({6, 4, 2, 1}); 
// æœŸæœ›: {42, 20, 6, 1}, å®é™…: é”™è¯¯

// ä¿®å¤å (æ­£ç¡®)
auto pt1 = encoder.encode(7);
auto pt2 = encoder.encode(6);
// æœŸæœ›: 42, å®é™…: 42 âœ…
```

### æ€§èƒ½ç“¶é¢ˆåˆ†æ

1. **ä¹˜æ³• 10,961 ms**: NTT åŠ é€Ÿç¦ç”¨ï¼Œä½¿ç”¨ O(nÂ²) schoolbook ä¹˜æ³•
2. **å¯†é’¥ç”Ÿæˆæ…¢**: ä»ä½¿ç”¨ NTL çš„ ZZ_pX è¿ç®—
3. **éšæœºæ•°ç”Ÿæˆ**: ç¼ºå°‘æ‰¹é‡ä¼˜åŒ–
4. **æ¶æ„é—®é¢˜**: æœªä½¿ç”¨ RNSPoly ç»Ÿä¸€è¡¨ç¤º

---

## 1. Phase 2 ç›®æ ‡ (ä¿®è®¢ç‰ˆ)

### 1.1 æ ¸å¿ƒç›®æ ‡

| ç›®æ ‡ | æè¿° | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| **ä¿®å¤ RNS-NTT-CRT** | è°ƒè¯•å¤§ç´ æ•°ä¸‹çš„æº¢å‡ºé—®é¢˜ | NTT ä¹˜æ³•æ­£ç¡® | P0 |
| **æ€§èƒ½æå‡ 100x** | å¯ç”¨ NTT åŠ é€Ÿå | Multiply < 200 ms | P0 |
| **BFV å®ç°** | Scale-invariant æ–¹æ¡ˆ | é€šè¿‡å¯¹æ¯”æµ‹è¯• | P1 |
| **ç»Ÿä¸€ RNS æ¶æ„** | å…±äº« RNSPoly åŸºç¡€è®¾æ–½ | å¤ç”¨ç‡ > 80% | P2 |

### 1.2 æ€§èƒ½ç›®æ ‡ (n=8192)

| æ“ä½œ | å½“å‰ (Schoolbook) | Phase 2 ç›®æ ‡ (NTT) | SEAL å‚è€ƒ |
|------|-------------------|-------------------|-----------|
| KeyGen | 1,312 ms | < 150 ms | 50 ms |
| Encrypt | 2,625 ms | < 30 ms | 5 ms |
| **Multiply** | **10,961 ms** | **< 100 ms** | 10 ms |
| Relin | 4,906 ms | < 300 ms | 50 ms |

### 1.3 é˜¶æ®µåˆ’åˆ†

**Phase 2a (å½“å‰): ä¿®å¤ NTT åŠ é€Ÿ**
- è°ƒè¯• `multiply_rns_ntt_crt()` å¤§ç´ æ•°é—®é¢˜
- éªŒè¯ NTT ä¹˜æ³•æ­£ç¡®æ€§
- é¢„æœŸæ€§èƒ½æå‡: 100x

**Phase 2b: BFV å®ç°**
- å®ç° BFV scale-invariant ç¼–ç 
- å®ç° BFV ä¹˜æ³• + rescale
- BFV æµ‹è¯•å¥—ä»¶

**Phase 2c: ä¼˜åŒ–å’Œæ•´åˆ**
- NTT è¡¨ç¼“å­˜ä¼˜åŒ–
- å¯†é’¥ç”Ÿæˆ NTT åŠ é€Ÿ
- æ€§èƒ½ benchmark å®Œå–„

---

## 2. æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 RNS å‚æ•°ä¿®å¤

**é—®é¢˜**: å½“å‰ä½¿ç”¨ 60-bit ç´ æ•°ï¼Œå¯¼è‡´ 128-bit ä¹˜æ³•æº¢å‡º

```cpp
// å½“å‰ (æœ‰é—®é¢˜)
params.primes = {(1ULL << 60) + ...};  // 60-bit ç´ æ•°

// ä¿®å¤æ–¹æ¡ˆ: ä½¿ç”¨å¤šä¸ª 50-bit ç´ æ•°
// æ¯ä¸ªç´ æ•° < 2^50ï¼Œä¹˜ç§¯ 2^50 * 2^50 = 2^100 < 2^128
params.primes = {
    1125899906842679,   // 2^50 - 89 + 2*n
    1125899906842241,   // 
    1125899906841153,   //
    ...                  // 6ä¸ªç´ æ•° for depth 5
};
```

### 2.2 NTT è¡¨ä¼˜åŒ–

```cpp
/**
 * @brief é¢„è®¡ç®— NTT è¡¨ï¼ˆæ¯ä¸ª RNS ç´ æ•°ä¸€ä»½ï¼‰
 * @note ä½¿ç”¨ lazy initialization + thread-safe singleton
 */
class NTTTableCache {
public:
    static NTTTableCache& instance();
    
    const NTTTable& get(size_t n, uint64_t prime) {
        auto key = std::make_pair(n, prime);
        std::lock_guard<std::mutex> lock(mutex_);
        
        if (cache_.find(key) == cache_.end()) {
            cache_.emplace(key, NTTTable(n, prime));
        }
        return cache_.at(key);
    }
    
private:
    std::map<std::pair<size_t, uint64_t>, NTTTable> cache_;
    std::mutex mutex_;
};
```

### 2.3 BFV æ–¹æ¡ˆæ ¸å¿ƒå·®å¼‚

| ç‰¹æ€§ | BGV | BFV |
|------|-----|-----|
| ç¼–ç  | m â†’ m (plaintext space) | m â†’ Î”Â·m where Î”=âŒŠq/tâŒ‹ |
| ä¹˜æ³•å | éœ€è¦æ¨¡æ•°åˆ‡æ¢é™å™ª | éœ€è¦é‡ç¼©æ”¾ (rescale) |
| å™ªå£°å¢é•¿ | çº¿æ€§å¢é•¿ | æ’å®šå¢é•¿ |
| ä¼˜åŠ¿åœºæ™¯ | ä½æ·±åº¦ç”µè·¯ | æ·±å±‚è®¡ç®— |

```cpp
// BFV ç¼–ç 
BGVPlaintext BFVEncoder::encode(int64_t value) {
    // scale by Î” = floor(q/t)
    ZZ delta = params_.q / params_.t;
    ZZ scaled = conv<ZZ>(value) * delta;
    return BGVPlaintext(scaled);
}

// BFV è§£ç 
int64_t BFVEncoder::decode(const BGVPlaintext& pt) {
    // round(pt / Î”) mod t
    ZZ delta = params_.q / params_.t;
    ZZ rounded = (rep(pt.data()[0]) + delta/2) / delta;
    return conv<long>(rounded % params_.t);
}
```

### 2.4 ç»Ÿä¸€å¤šé¡¹å¼è¿ç®—å±‚

```cpp
namespace kctsb::fhe::common {

/**
 * @brief RNS å¤šé¡¹å¼ç»Ÿä¸€è¡¨ç¤º
 * @note BGV/BFV/CKKS å…±ç”¨
 */
class RNSPoly {
public:
    RNSPoly(size_t n, const std::vector<uint64_t>& primes);
    
    // NTT æ“ä½œ
    void to_ntt();
    void from_ntt();
    
    // ç®—æœ¯è¿ç®— (NTT åŸŸ)
    RNSPoly& operator+=(const RNSPoly& other);
    RNSPoly& operator-=(const RNSPoly& other);
    RNSPoly& operator*=(const RNSPoly& other);  // NTT åŸŸç‚¹ä¹˜
    
    // RNS å±‚è®¿é—®
    std::span<uint64_t> level(size_t i);
    std::span<const uint64_t> level(size_t i) const;
    
private:
    size_t n_;
    std::vector<uint64_t> primes_;
    std::vector<std::vector<uint64_t>> data_;  // [level][coeff]
    bool is_ntt_;
};

}  // namespace kctsb::fhe::common
```

---

## 3. å®æ–½è®¡åˆ’

### 3.1 é˜¶æ®µä»»åŠ¡

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|----------|------|
| 3.1.1 ä¿®å¤ RNS å‚æ•° | 2h | - |
| 3.1.2 NTT è¡¨ç¼“å­˜ä¼˜åŒ– | 1h | 3.1.1 |
| 3.1.3 å¯†é’¥ç”Ÿæˆ NTT åŠ é€Ÿ | 2h | 3.1.2 |
| 3.1.4 éªŒè¯ n=8192 æ­£ç¡®æ€§ | 1h | 3.1.3 |
| 3.1.5 BFV ç¼–ç å™¨ | 2h | 3.1.4 |
| 3.1.6 BFV ä¹˜æ³•/é‡ç¼©æ”¾ | 3h | 3.1.5 |
| 3.1.7 BFV æµ‹è¯• | 2h | 3.1.6 |
| 3.1.8 æ€§èƒ½ benchmark | 1h | 3.1.7 |

**æ€»è®¡**: ~14 å°æ—¶

### 3.2 æ–‡ä»¶å˜æ›´

```
ä¿®æ”¹æ–‡ä»¶:
  src/advanced/fe/bgv/bgv_context.cpp    # RNS å‚æ•°ä¿®å¤
  src/advanced/fe/common/ntt.cpp          # NTT è¡¨ç¼“å­˜
  src/advanced/fe/bgv/bgv_evaluator.cpp   # å¯†é’¥ç”Ÿæˆä¼˜åŒ–

æ–°å¢æ–‡ä»¶:
  include/kctsb/advanced/fe/bfv/bfv.hpp           # BFV å…¬å…±æ¥å£
  src/advanced/fe/bfv/bfv_context.cpp             # BFV ä¸Šä¸‹æ–‡
  src/advanced/fe/bfv/bfv_encoder.cpp             # BFV ç¼–ç å™¨
  src/advanced/fe/bfv/bfv_evaluator.cpp           # BFV è¿ç®—
  tests/unit/fhe/test_bfv.cpp                     # BFV æµ‹è¯•
```

---

## 4. éªŒæ”¶æ ‡å‡†

### 4.1 åŠŸèƒ½éªŒæ”¶

| æµ‹è¯•é¡¹ | éªŒæ”¶æ ‡å‡† |
|--------|----------|
| BGV n=8192 ä¹˜æ³• | Multiplication correctness: PASS |
| BFV åŸºç¡€è¿ç®— | åŠ æ³•/ä¹˜æ³•/é‡ç¼©æ”¾æ­£ç¡® |
| BFV æ·±åº¦è®¡ç®— | 5å±‚ä¹˜æ³•æ­£ç¡®è§£å¯† |
| å‚æ•°å…¼å®¹ | TOY/128/192 å‚æ•°é›†é€šè¿‡ |

### 4.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | éªŒæ”¶ |
|------|------|------|------|
| Multiply (n=8192) | 36,371 ms | < 500 ms | 72x æå‡ |
| KeyGen | 1,305 ms | < 200 ms | 6.5x æå‡ |
| Encrypt | 2,656 ms | < 50 ms | 53x æå‡ |

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| RNS å‚æ•°é€‰æ‹©å›°éš¾ | ä¸­ | é«˜ | å‚è€ƒ SEAL/HElib æ ‡å‡†å‚æ•° |
| æ€§èƒ½ç›®æ ‡è¿‡é«˜ | ä¸­ | ä¸­ | åˆ†é˜¶æ®µä¼˜åŒ–ï¼Œå…ˆè¾¾åˆ° 10x |
| BFV é‡ç¼©æ”¾å¤æ‚ | ä½ | ä¸­ | å¤ç”¨ BGV æ¨¡æ•°åˆ‡æ¢é€»è¾‘ |

---

*Phase 2 è®¾è®¡æ–‡æ¡£ç»“æŸ*
