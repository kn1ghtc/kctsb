# kctsb v4.9.0 Phase 4 è®¾è®¡æ–‡æ¡£ - æ€§èƒ½ä¼˜åŒ–ä¸ NTT é›†æˆ

> **ç‰ˆæœ¬**: v4.9.0 Phase 4  
> **æ—¥æœŸ**: 2026-01-23 (Beijing Time, UTC+8)  
> **çŠ¶æ€**: âœ… **Barrett/CRTä¼˜åŒ–å®Œæˆ** | ğŸ”„ NTTPolyé‡æ„å¾…å®š

---

## 0. èƒŒæ™¯ä¸åŠ¨æœº

### 0.1 Phase 1-3 å®Œæˆæ€»ç»“

| Phase | å†…å®¹ | çŠ¶æ€ | æµ‹è¯• | å…³é”®æˆæœ |
|-------|------|------|------|----------|
| Phase 1 | BGV æ ¸å¿ƒ | âœ… å®Œæˆ | 43/43 | NTT å¤šé¡¹å¼è¿ç®— |
| Phase 2 | BFV å®ç° | âœ… å®Œæˆ | 25/25 | Î”-ç¼©æ”¾ç¼–ç  |
| Phase 3 | CKKS è¿‘ä¼¼ | âœ… å®Œæˆ | 33/33 | FFT ç¼–ç  + Rescale |
| **Phase 4a** | **NTT Barrettä¼˜åŒ–** | âœ… å®Œæˆ | 185/185 | mul_mod_barrett |
| **Phase 4b** | **NTTPolyé‡æ„** | ğŸ”„ å¾…å®š | - | çº¯uint64_t RNS |

### 0.2 æ€§èƒ½ç°çŠ¶ (Phase 4a å®Œæˆå)

| æ“ä½œ (n=8192) | kctsb (ms) | SEAL 4.1 (ms) | å·®è· | æ ¹å›  |
|------|-----------|---------------|------|------|
| KeyGen | 1721 | 50 | 34x | ZZ_pX å¯†é’¥å¤šé¡¹å¼ |
| Encrypt | 3494 | 5 | 699x | ZZ_pXâ†’uint64è½¬æ¢ |
| Decrypt | 1719 | 2 | 860x | æ¨¡è¿ç®— |
| **Multiply** | **1353** | 10 | **135x** | RNS/CRTé‡æ„å¼€é”€ |
| Multiply+Relin | 9650 | 18 | 536x | å¯†é’¥åˆ‡æ¢ |
| Add | 0.65 | 0.1 | 6x | âœ… å·²è¾¾ç›®æ ‡é™„è¿‘ |

**Phase 4a ä¼˜åŒ–æˆæœ**:
- âœ… NTTæ ¸å¿ƒå‡½æ•°ï¼š`mul_mod_slow` â†’ `mul_mod_barrett` (æ‰€æœ‰æ ‡é‡å’ŒAVX2è·¯å¾„)
- âœ… CRTé‡æ„ï¼šé¢„è®¡ç®— `CRTConstants` (Q_i, Q_i_inv)
- âœ… 50-bit å¤§ç´ æ•°æ”¯æŒï¼šæ··åˆ Barrett + ç›´æ¥æ¨¡è¿ç®—
- âœ… æµ‹è¯•é€šè¿‡ï¼š78 NTT/RNS + 107 BGV/BFV/CKKS = 185 æµ‹è¯•

### 0.3 Phase 4 åˆ†æç»“è®º

**å·²å®Œæˆçš„ç®—æ³•å±‚ä¼˜åŒ–**æ— æ³•è¿›ä¸€æ­¥æ˜¾è‘—æå‡æ€§èƒ½ã€‚ç“¶é¢ˆåœ¨ **æ•°æ®ç±»å‹å±‚**:

| ç“¶é¢ˆ | æè¿° | SEALåšæ³• |
|------|------|----------|
| `reduce_to_prime()` | æ¯ä¸ªç³»æ•° ZZ % q å¤§æ•´æ•°é™¤æ³• | ç›´æ¥ uint64_t å­˜å‚¨ |
| `crt_reconstruct()` | æ¯ä¸ªç³»æ•° CRT é‡å»ºæ¶‰åŠå¤§æ•´æ•°ä¹˜æ³• | å»¶è¿Ÿ CRTï¼Œä¿æŒ RNS å½¢å¼ |
| `ZZ_pX â†” uint64_t` | æ¯æ¬¡ NTT å‰åè½¬æ¢ ~O(n) | åŸç”Ÿ RNS å¤šé¡¹å¼ç±» |

**ç»“è®º**: è¾¾åˆ° SEAL 10x ä»¥å†…éœ€è¦ **Phase 4b: NTTPoly å®Œæ•´é‡æ„**ï¼ˆå·¥ç¨‹é‡å¤§ï¼‰ã€‚

### 0.4 Phase 4 ç›®æ ‡è°ƒæ•´

- ~~å°† kctsb åŒæ€åŠ å¯†æ€§èƒ½æå‡åˆ° SEAL çš„ 10-20x ä»¥å†…~~
- âœ… **Phase 4a**: å®Œæˆ NTT Barrett ä¼˜åŒ–ï¼ŒéªŒè¯æ¶æ„ç“¶é¢ˆ
- ğŸ”„ **Phase 4b**: çº¯ RNS uint64_t é‡æ„ï¼ˆå¯é€‰ï¼Œå·¥ç¨‹é‡å¤§ï¼‰

---

## 1. æ€§èƒ½ç“¶é¢ˆåˆ†æ

### 1.1 å¤šé¡¹å¼ä¹˜æ³•

**å½“å‰å®ç°**: ä½¿ç”¨ NTL ZZ_pX å¤šé¡¹å¼ä¹˜æ³•
- å¤æ‚åº¦: O(nÂ²) æˆ– O(n log n)ï¼ˆä¾èµ– NTL å†…éƒ¨å®ç°ï¼‰
- æ—  SIMD å‘é‡åŒ–
- å•ä¸€æ¨¡æ•° ZZ_p

**SEAL å®ç°**: RNS + NTT + AVX2
- å¤æ‚åº¦: O(n log n) æ¯ä¸ªæ¨¡æ•°åˆ†é‡
- AVX2 æ‰¹é‡å¤„ç† 4-8 ä¸ª 64-bit æ•°
- å¤šæ¨¡æ•°å¹¶è¡Œ

**ä¼˜åŒ–æ–¹æ¡ˆ**: å°† `fe/common/ntt.h` é›†æˆåˆ° FHE æ¨¡å—

### 1.2 é«˜æ–¯é‡‡æ ·

**å½“å‰å®ç°**: æ¯æ¬¡é‡‡æ ·è°ƒç”¨ CSPRNG
- æ— é¢„è®¡ç®—
- æ ‡é‡æ“ä½œ

**ä¼˜åŒ–æ–¹æ¡ˆ**: 
- é¢„ç”Ÿæˆé«˜æ–¯å™ªå£°è¡¨
- æ‰¹é‡é‡‡æ ·

### 1.3 å¯†é’¥ç”Ÿæˆ

**å½“å‰å®ç°**: æ¯æ¬¡ç”Ÿæˆå®Œæ•´å¯†é’¥
- æ— å¯†é’¥ç¼“å­˜
- é‡å¤è®¡ç®—

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- çº¿ç¨‹å®‰å…¨å¯†é’¥ç¼“å­˜
- å»¶è¿Ÿå¯†é’¥ç”Ÿæˆ

---

## 2. Phase 4 æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 NTT å¤šé¡¹å¼é›†æˆ

```cpp
// ç›®æ ‡: æ›¿æ¢ ZZ_pX ä¸º NTTPoly

class NTTPoly {
public:
    // RNS åˆ†è§£: æ¯ä¸ª modulus ä¸€ç»„ç³»æ•°
    std::vector<std::vector<uint64_t>> rns_components;
    
    // NTT çŠ¶æ€
    bool is_ntt_form;
    
    // è¿ç®— (åœ¨ NTT åŸŸ)
    NTTPoly operator+(const NTTPoly& other) const;
    NTTPoly operator-(const NTTPoly& other) const;
    NTTPoly operator*(const NTTPoly& other) const;  // é€ç‚¹ä¹˜æ³•
    
    // è½¬æ¢
    void to_ntt();
    void to_coeff();
};
```

### 2.2 ä¼˜åŒ–åçš„åŠ å¯†æµç¨‹

```cpp
// å½“å‰: O(nÂ²) å¤šé¡¹å¼ä¹˜æ³•
Ciphertext encrypt(const PublicKey& pk, const Plaintext& pt) {
    auto a = pk.a;
    auto e = sample_error();
    auto c0 = pt + a * s + e;  // ZZ_pX ä¹˜æ³• O(nÂ²)
    ...
}

// ä¼˜åŒ–å: O(n log n) NTT ä¹˜æ³•
Ciphertext encrypt_ntt(const PublicKey& pk, const Plaintext& pt) {
    auto a_ntt = pk.a_ntt;     // é¢„è½¬æ¢
    auto s_ntt = s.to_ntt();
    auto as = a_ntt * s_ntt;   // é€ç‚¹ä¹˜æ³• O(n)
    as.to_coeff();
    auto c0 = pt + as + e;
    ...
}
```

### 2.3 é¢„æœŸæ€§èƒ½æå‡

| ä¼˜åŒ–æªæ–½ | ç›®æ ‡æå‡ | å¤æ‚åº¦ | æ¶‰åŠæ–‡ä»¶ |
|----------|----------|--------|----------|
| NTT å¤šé¡¹å¼ä¹˜æ³• | 10-30x | é«˜ | bgv_context, bfv_context, ckks_* |
| æ‰¹é‡é«˜æ–¯é‡‡æ · | 5-10x | ä½ | bgv_keygen, random |
| å¯†é’¥ç¼“å­˜ | 2x | ä½ | bgv_context |
| AVX2 åŠ æ³•/å‡æ³• | 2-3x | ä¸­ | ntt_avx2 |

**ç»¼åˆç›®æ ‡**: 50-100x æå‡ â†’ æ¥è¿‘ SEAL 10x ä»¥å†…

---

## 3. å®ç°è®¡åˆ’

### 3.1 é˜¶æ®µåˆ’åˆ†

| å­é˜¶æ®µ | å†…å®¹ | é¢„ä¼°å·¥ä½œé‡ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|--------|------|------------|--------|------|
| P4a.1 | NTT Barrett ä¼˜åŒ– | 0.5 å¤© | P0 | âœ… å®Œæˆ |
| P4a.2 | RNS Barrett ä¼˜åŒ– | 0.5 å¤© | P0 | âœ… å®Œæˆ |
| P4a.3 | CRT é¢„è®¡ç®—ä¼˜åŒ– | 0.5 å¤© | P0 | âœ… å®Œæˆ |
| P4a.4 | AVX2 è·¯å¾„ Barrett | 0.5 å¤© | P0 | âœ… å®Œæˆ |
| P4a.5 | 50-bit ç´ æ•°ä¿®å¤ | 0.5 å¤© | P0 | âœ… å®Œæˆ |
| P4a.6 | å›å½’æµ‹è¯• (185æµ‹è¯•) | 0.5 å¤© | P0 | âœ… å®Œæˆ |
| **P4b.1** | **NTTPoly ç±»é‡æ„** | 3 å¤© | P1 | ğŸ”„ å¾…å®š |
| P4b.2 | BGV é›†æˆçº¯ RNS | 2 å¤© | P1 | ğŸ”„ å¾…å®š |
| P4b.3 | BFV/CKKS é›†æˆ | 2 å¤© | P1 | ğŸ”„ å¾…å®š |

**Phase 4a å·²å®Œæˆ**: ~3 å¤©
**Phase 4b å¾…å®š**: ~7 å¤©ï¼ˆå¯é€‰ï¼Œå¤§å·¥ç¨‹é‡ï¼‰

### 3.2 éªŒæ”¶æ ‡å‡†

| æ“ä½œ (n=8192) | åŸºçº¿ (ms) | Phase 4a ç»“æœ (ms) | Phase 4b ç›®æ ‡ (ms) | SEAL (ms) |
|------|-----------|-------------------|-------------------|-------------|
| Encrypt | 8650 | 3494 (**2.5x â†‘**) | < 200 | 5 |
| Decrypt | 4240 | 1719 (**2.5x â†‘**) | < 100 | 2 |
| Multiply | 3434 | 1353 (**2.5x â†‘**) | < 100 | 10 |
| Multiply+Relin | 25123 | 9650 (**2.6x â†‘**) | < 500 | 18 |
| Add | 1.0 | 0.65 (**1.5x â†‘**) | < 0.3 âœ… | 0.1 |

**Phase 4a æˆæœæ€»ç»“**:
- æ‰€æœ‰æ“ä½œè·å¾— **2-3x æé€Ÿ**
- åŠ æ³•å·²æ¥è¿‘ç›®æ ‡ï¼ˆ0.65ms vs 0.3ms ç›®æ ‡ï¼‰
- ä¹˜æ³•ä» ~3400ms é™è‡³ ~1350msï¼ˆä»ä¸ SEAL å·® 135xï¼‰

---

## 4. é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£ |
|------|------|------|------|
| NTT é›†æˆç ´åç°æœ‰æµ‹è¯• | é«˜ | é«˜ | ä¿ç•™ ZZ_pX è·¯å¾„ï¼Œé€æ­¥è¿ç§» |
| RNS ç²¾åº¦é—®é¢˜ | ä¸­ | é«˜ | å‚è€ƒ SEAL å®ç° |
| AVX2 å¯ç§»æ¤æ€§ | ä½ | ä½ | ä½¿ç”¨ç¼–è¯‘æ—¶æ£€æµ‹ |

---

## 5. æµ‹è¯•ç­–ç•¥

### 5.1 å›å½’æµ‹è¯•

```bash
# ç¡®ä¿æ‰€æœ‰ç°æœ‰æµ‹è¯•ä»é€šè¿‡
ctest --test-dir build -R "BGV|BFV|CKKS" --output-on-failure
```

### 5.2 æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½åŸºå‡†
./build/bin/kctsb_benchmark_bgv
./build/bin/kctsb_benchmark_ckks
```

### 5.3 æ­£ç¡®æ€§å¯¹æ¯”

ä½¿ç”¨ç›¸åŒå‚æ•°ä¸ SEAL 4.1 è¿›è¡Œäº¤å‰éªŒè¯ã€‚

---

## 6. Phase 4a å®Œæˆæ€»ç»“

### 6.1 ä»£ç å˜æ›´

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `src/advanced/fe/common/ntt.cpp` | Barrett æ›¿æ¢ mul_mod_slow (æ ‡é‡+AVX2)ï¼›50-bit ç´ æ•°æ··åˆå¤„ç† |
| `src/advanced/fe/common/rns.cpp` | operator*= å’Œ convert ä½¿ç”¨ Barrett |
| `include/.../bgv_ntt_helper.hpp` | CRTConstants é¢„è®¡ç®—ç»“æ„ï¼›crt_reconstruct_fast ä¼˜åŒ– |

### 6.2 æµ‹è¯•éªŒè¯

```bash
# 2026-01-23 æµ‹è¯•ç»“æœ
$ ctest --test-dir build -R "^NTT|^RNS" --output-on-failure
78/78 tests passed (7.81 sec)

$ ctest --test-dir build -R "^BGV|^BFV|^CKKS" --output-on-failure
107/107 tests passed (263.87 sec)
```

### 6.3 æ€§èƒ½ç“¶é¢ˆç¡®è®¤

Barrett ä¼˜åŒ–åï¼Œprofiling æ˜¾ç¤ºä¸»è¦è€—æ—¶åœ¨:
1. `reduce_to_prime()`: ZZ % q å¤§æ•´æ•°é™¤æ³• (~40%)
2. `crt_reconstruct_fast()`: ZZ å¤§æ•´æ•°ä¹˜æ³• (~35%)
3. `zz_px_to_uint64()` / `uint64_to_zz_px()`: ç±»å‹è½¬æ¢ (~15%)

**ç»“è®º**: éœ€è¦ **Phase 4b çº¯ RNS é‡æ„** æ‰èƒ½æ¶ˆé™¤è¿™äº›ç“¶é¢ˆã€‚

---

## 7. Phase 5 å±•æœ›

Phase 4 å®Œæˆåï¼Œè€ƒè™‘ä»¥ä¸‹æ–¹å‘ï¼š

| æ–¹å‘ | å†…å®¹ | ä¼˜å…ˆçº§ |
|------|------|--------|
| Phase 4b | çº¯ RNS uint64_t å¤šé¡¹å¼ç±» | P1 |
| Bootstrapping | CKKS/BGV è‡ªä¸¾ | P2 |
| SIMD Batching | æ‰¹é‡ slot è¿ç®— | P1 |
| Python ç»‘å®š | pybind11 æ¥å£ | P2 |
| PSI/PIR é›†æˆ | ä½¿ç”¨åŸç”Ÿ FHE | P1 |

---

*Phase 4a å®Œæˆ - 2026-01-23*
*Phase 4b å¾…å®š - éœ€è¦å¤§è§„æ¨¡æ¶æ„é‡æ„*
