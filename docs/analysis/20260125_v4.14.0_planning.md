# kctsb v4.14.0 Planning Document

> **规划日期**: 2026-01-25 (Beijing Time, UTC+8)  
> **目标版本**: v4.14.0  
> **主题**: PSI/PIR Production Enhancement + SEAL Benchmark Fix

---

## 1. 问题陈述

### 1.1 待解决问题
1. **SEAL Benchmark 编译失败** - `seal/util/config.h` 缺失
   - 当前状态: 尝试包含 SEAL 源码头文件，但缺少构建生成的 config.h
   - 解决方案: 仅在 benchmark 链接预编译静态库，不源码依赖 SEAL

2. **Test/Benchmark 未集成 CMake**
   - 测试代码 `tests/unit/advanced/test_psi_pir.cpp` 已完成
   - 需要添加到 CMakeLists.txt

### 1.2 功能增强需求
1. **OT-PSI 生产级实现**
   - 自包含 IKNP OT Extension 协议
   - 利用 kctsb 硬件加速 (AES-NI, SHA-NI)
   - 达到/超越 libOTe 性能

2. **CUDA GPU 加速 PIR**
   - 自包含 CUDA 实现
   - 同态加密向量化运算

3. **多方 PSI (3+ 参与方)**
   - 基于 OT Extension 的多方协议

4. **PSI-CA (Cardinality + Attributes)**
   - 仅返回交集大小 + 属性

5. **PIR with Preprocessing**
   - 摊销密钥生成成本

---

## 2. 范围分析

### 2.1 会修改的文件
| 文件 | 操作 | 说明 |
|------|------|------|
| src/advanced/psi/seal_pir.cpp | 删除 | 移除源码依赖 |
| benchmarks/benchmark_psi_pir.cpp | 重写 | 使用预编译 SEAL 静态库 |
| benchmarks/CMakeLists.txt | 修改 | 添加 PSI/PIR benchmark 配置 |
| tests/CMakeLists.txt | 修改 | 添加 test_psi_pir.cpp |
| CMakeLists.txt | 修改 | SEAL 依赖仅限 benchmark |

### 2.2 新增文件
| 文件 | 说明 |
|------|------|
| src/advanced/psi/ot_extension.cpp | IKNP OT Extension 生产实现 |
| include/kctsb/advanced/psi/ot_extension.h | OT Extension 头文件 |
| src/advanced/psi/cuda/pir_cuda.cu | CUDA PIR 内核 |
| src/advanced/psi/cuda/pir_cuda.cpp | CUDA PIR C++ 接口 |
| include/kctsb/advanced/psi/pir_cuda.h | CUDA PIR 头文件 |
| src/advanced/psi/multi_party_psi.cpp | 多方 PSI |
| include/kctsb/advanced/psi/multi_party_psi.h | 多方 PSI 头文件 |
| src/advanced/psi/psi_ca.cpp | PSI-CA |
| include/kctsb/advanced/psi/psi_ca.h | PSI-CA 头文件 |
| docs/releases/v4Release/v4.14.0-release.md | 版本发布文档 |

### 2.3 不会修改的文件
- src/advanced/psi/piano_psi.cpp - 保留现有实现
- src/advanced/psi/native_pir.cpp - 仅增强，不重写
- 其他 crypto/math 模块 - 不涉及

---

## 3. 技术方案

### 3.1 SEAL Benchmark 修复

**策略**: 参考 benchmark_bgv.cpp 的实现方式

```cmake
# benchmarks/CMakeLists.txt
if(EXISTS "${SEAL_LIBRARY}" AND EXISTS "${SEAL_INCLUDE_DIR}")
    add_executable(bench_psi_pir ...)
    target_link_libraries(bench_psi_pir PRIVATE "${SEAL_LIBRARY}")
    target_compile_definitions(bench_psi_pir PRIVATE KCTSB_HAS_SEAL=1)
endif()
```

### 3.2 生产级 OT Extension

**IKNP 协议核心**:
1. Base OTs (k=128) - 使用 Diffie-Hellman
2. OT Extension - AES-NI 加速伪随机生成
3. 消息恢复 - SHA-NI 加速哈希

**性能目标**:
- 10K OTs: < 50ms
- 100K OTs: < 400ms
- vs libOTe: ≥ 1.0x

### 3.3 CUDA GPU PIR

**核心内核**:
- NTT Forward/Inverse (GPU 并行)
- 同态乘法 (slot-wise)
- RNS CRT 重建

**依赖**:
- CUDA 11.0+
- cuBLAS (可选)

### 3.4 多方 PSI

**协议**: Star Topology (Server-centric)
- 中心服务器聚合
- 成对 OT-PSI
- 交集验证

### 3.5 PSI-CA

**功能**:
- 仅返回 |A ∩ B|
- 附带属性提取
- 差分隐私保护 (可选)

---

## 4. 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| CUDA 编译环境不可用 | GPU PIR 无法构建 | 条件编译，fallback to CPU |
| OT Extension 性能不达标 | 低于 libOTe | 使用更多硬件加速 |
| SEAL 静态库不兼容 | Benchmark 失败 | 保留 kctsb-only benchmark |

---

## 5. 成功标准

1. [ ] SEAL Benchmark 编译通过
2. [ ] PSI/PIR 测试集成到 CTest
3. [ ] OT Extension 通过安全测试向量
4. [ ] CUDA PIR 在 RTX 3090 上性能 ≥ 2x CPU
5. [ ] 多方 PSI 支持 3-5 参与方
6. [ ] 所有新功能有 GoogleTest 覆盖
7. [ ] README 更新使用场景说明

---

## 6. 实施顺序

1. **Phase 1**: 修复编译问题 (SEAL Benchmark, CMake 集成)
2. **Phase 2**: OT Extension 生产实现
3. **Phase 3**: CUDA GPU PIR
4. **Phase 4**: 多方 PSI + PSI-CA
5. **Phase 5**: PIR Preprocessing
6. **Phase 6**: 文档和测试

---

*规划完成: 2026-01-25*
