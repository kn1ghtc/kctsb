name: kctsb CI/CD - Build, Test & Performance Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

env:
  CMAKE_VERSION: 3.20
  PERFORMANCE_THRESHOLD: 5
  BLAKE2B_THRESHOLD: 3

jobs:
  # ============================================================================
  # Windows Build & Test (MinGW64)
  # ============================================================================
  windows-mingw:
    name: Windows MinGW64 + Performance Benchmark
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2 MinGW64
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-openssl

      - name: Configure CMake (Release)
        shell: msys2 {0}
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=C:/msys64/mingw64/bin/gcc.exe \
            -DCMAKE_CXX_COMPILER=C:/msys64/mingw64/bin/g++.exe \
            -DKCTSB_BUILD_TESTS=ON \
            -DKCTSB_BUILD_CLI=ON \
            -DKCTSB_BUILD_BENCHMARKS=ON \
            -DKCTSB_WARNINGS_AS_ERRORS=ON

      - name: Build kctsb
        shell: msys2 {0}
        run: cmake --build build --parallel

      - name: Run Unit Tests
        shell: msys2 {0}
        run: |
          cd build
          ctest --output-on-failure --timeout 300

      - name: Run Performance Benchmark
        shell: msys2 {0}
        run: |
          cd build/bin
          ./kctsb_benchmark.exe all > ../../benchmark_results.txt

      - name: Check Performance Regression
        shell: pwsh
        run: |
          python scripts/check_performance.py `
            --baseline docs/PERFORMANCE_BASELINE.md `
            --current benchmark_results.txt `
            --fail-on-regression `
            --threshold ${{ env.PERFORMANCE_THRESHOLD }} `
            --blake2b-threshold ${{ env.BLAKE2B_THRESHOLD }}

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results-windows
          path: benchmark_results.txt
          retention-days: 30

      - name: Comment PR with Performance Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('benchmark_results.txt')) {
              const report = fs.readFileSync('benchmark_results.txt', 'utf8');
              const lines = report.split('\n');
              const summary = lines.slice(0, Math.min(40, lines.length)).join('\n');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸš€ Performance Benchmark Results\n\n\`\`\`\n${summary}\n...(see artifact)\n\`\`\``
              });
            }

  # ============================================================================
  # Linux Build & Test (Ubuntu)
  # ============================================================================
  linux-gcc:
    name: Linux GCC 11+ + Sanitizers
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compiler: [gcc-11, gcc-12]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ${{ matrix.compiler }} \
            g++-$(echo ${{ matrix.compiler }} | cut -d- -f2) \
            cmake ninja-build \
            libgmp-dev libntl-dev libssl-dev

      - name: Configure CMake (Debug + ASan)
        run: |
          export CC=$(echo ${{ matrix.compiler }})
          export CXX=g++-$(echo ${{ matrix.compiler }} | cut -d- -f2)
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DKCTSB_BUILD_TESTS=ON \
            -DKCTSB_BUILD_CLI=ON \
            -DCMAKE_CXX_FLAGS="-fsanitize=address -fsanitize=undefined -fno-omit-frame-pointer"

      - name: Build kctsb
        run: cmake --build build --parallel

      - name: Run Tests with ASan/UBSan
        run: |
          cd build
          ctest --output-on-failure --timeout 300
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1

  # ============================================================================
  # macOS Build & Test (ARM64)
  # ============================================================================
  macos-clang:
    name: macOS Clang (ARM64)
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies (Homebrew)
        run: |
          brew install cmake ninja gmp ntl openssl@3

      - name: Configure CMake (Release)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DKCTSB_BUILD_TESTS=ON \
            -DKCTSB_BUILD_CLI=ON \
            -DKCTSB_BUILD_BENCHMARKS=ON \
            -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl@3

      - name: Build kctsb
        run: cmake --build build --parallel

      - name: Run Unit Tests
        run: |
          cd build
          ctest --output-on-failure --timeout 300

  # ============================================================================
  # Static Analysis
  # ============================================================================
  static-analysis:
    name: Static Analysis (cppcheck)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            -I include/ -I src/ \
            src/

  # ============================================================================
  # Documentation Build
  # ============================================================================
  docs-check:
    name: Documentation Build (Doxygen)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Doxygen
        run: sudo apt-get install -y doxygen graphviz

      - name: Generate Documentation
        run: |
          if [ -f docs/Doxyfile ]; then
            cd docs && doxygen Doxyfile
          else
            echo "Doxyfile not found, skipping documentation generation"
          fi

      - name: Upload Docs Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doxygen-docs
          path: docs/html/
          retention-days: 7
